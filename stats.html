<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>総合成績 / 個人成績</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.firebasestorage.app",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31",
      measurementId: "G-NP9EELBD7R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allSessions = [];

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('startDate').addEventListener('change', filterAndCalculate);
      document.getElementById('endDate').addEventListener('change', filterAndCalculate);

      onSnapshot(collection(db, 'sessions'), snapshot => {
        allSessions = [];
        snapshot.forEach(doc => allSessions.push(doc.data()));
        filterAndCalculate();
      });
    });

    function filterAndCalculate() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const filtered = allSessions.map(s => ({
        ...s,
        games: s.games.filter(g => {
          if (!g.date) return false;
          return (!start || g.date >= start) && (!end || g.date <= end);
        })
      })).filter(s => s.games.length > 0);
      calculateStats(filtered);
    }

    window.viewPlayerDetail = function(name) {
      const p = window.playerData[name];
      if (!p) return;
      const detailDiv = document.getElementById('playerDetail');
      detailDiv.innerHTML = `
        <div class="player-detail">
          <h2>${p.name} の成績詳細</h2>
          <p>対局数: ${p.games}回 / 合計ポイント: ${p.totalPoint >= 0 ? '+' : ''}${p.totalPoint}</p>
          <canvas id="pointChart"></canvas>
          <canvas id="rankChart"></canvas>
        </div>
      `;
      drawGraphs(p);
    }

    function drawGraphs(p) {
      const ctx1 = document.getElementById('pointChart').getContext('2d');
      new Chart(ctx1, {
        type: 'line',
        data: {
          labels: p.pointHistory.map((_, i) => i + 1),
          datasets: [{ label: '累積ポイント推移', data: p.pointHistory, borderColor: 'blue', fill: false }]
        },
        options: { responsive: true, scales: { x: { ticks: { stepSize: 5 } }, y: { title: { display: true, text: 'ポイント' } } } }
      });
      const avgRanks = p.rankHistory.map((_, i, arr) => (arr.slice(0, i + 1).reduce((a, b) => a + b, 0) / (i + 1)).toFixed(2));
      const ctx2 = document.getElementById('rankChart').getContext('2d');
      new Chart(ctx2, {
        type: 'line',
        data: {
          labels: avgRanks.map((_, i) => i + 1),
          datasets: [{ label: '平均着順推移', data: avgRanks, borderColor: 'green', fill: false }]
        },
        options: { responsive: true, scales: { x: { ticks: { stepSize: 5 } }, y: { reverse: true, min: 1, max: 4 } } }
      });
    }

    window.calculateStats = function(sessions) {
      const playerData = {};
      sessions.forEach((session, sessionIndex) => {
        session.games.forEach((game, gameIndex) => {
          const sorted = [...game.players].sort((a, b) => b.point - a.point);
          sorted.forEach((p, i) => {
            if (!playerData[p.name]) {
              playerData[p.name] = {
                name: p.name, games: 0, tops: 0, seconds: 0, thirds: 0, fourths: 0,
                totalRank: 0, totalPoint: 0, pointHistory: [], rankHistory: []
              };
            }
            const data = playerData[p.name];
            data.games++;
            data.totalRank += (i + 1);
            data.totalPoint += p.point;
            data.pointHistory.push(data.totalPoint);
            data.rankHistory.push(i + 1);
            if (i === 0) data.tops++;
            if (i === 1) data.seconds++;
            if (i === 2) data.thirds++;
            if (i === 3) data.fourths++;
          });
        });
      });

      const tbody = document.querySelector('#statsTable tbody');
      tbody.innerHTML = '';
      const stats = Object.values(playerData);

      const columns = [
        p => p.games,
        p => p.totalPoint,
        p => p.tops,
        p => p.seconds,
        p => p.thirds,
        p => p.fourths,
        p => (p.tops / p.games) * 100,
        p => ((p.tops + p.seconds) / p.games) * 100,
        p => ((p.tops + p.seconds + p.thirds) / p.games) * 100,
        p => p.totalRank / p.games,
        p => p.totalPoint / p.games
      ];

      const maxIndex = Array(11).fill(null);
      const minIndex = Array(11).fill(null);
      const maxVals = Array(11).fill(-Infinity);
      const minVals = Array(11).fill(Infinity);

      stats.forEach((p, idx) => {
        columns.forEach((colFn, colIdx) => {
          const val = colFn(p);
          if (val > maxVals[colIdx]) {
            maxVals[colIdx] = val;
            maxIndex[colIdx] = idx;
          }
          if (val < minVals[colIdx]) {
            minVals[colIdx] = val;
            minIndex[colIdx] = idx;
          }
        });
      });

      stats.forEach((p, idx) => {
        const avgRank = (p.totalRank / p.games).toFixed(2);
        const avgPoint = (p.totalPoint / p.games).toFixed(2);
        const topRate = ((p.tops / p.games) * 100).toFixed(1) + '%';
        const doubleRate = (((p.tops + p.seconds) / p.games) * 100).toFixed(1) + '%';
        const avoidLastRate = (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1) + '%';
        const tr = document.createElement('tr');
        const cells = [
          `<td><span class="clickable-name" onclick="viewPlayerDetail('${p.name}')">${p.name}</span></td>`,
          `<td>${p.games}</td>`,
          `<td>${p.totalPoint >= 0 ? '+' : ''}${p.totalPoint}</td>`,
          `<td>${p.tops}</td>`,
          `<td>${p.seconds}</td>`,
          `<td>${p.thirds}</td>`,
          `<td>${p.fourths}</td>`,
          `<td>${topRate}</td>`,
          `<td>${doubleRate}</td>`,
          `<td>${avoidLastRate}</td>`,
          `<td>${avgRank}</td>`,
          `<td>${avgPoint}</td>`
        ];
        tr.innerHTML = cells.map((cell, i) => {
          if (i > 0 && i <= 11) {
            const ci = i - 1;
            if (idx === maxIndex[ci]) return cell.replace('<td', '<td class="highlight-max"');
            if (idx === minIndex[ci]) return cell.replace('<td', '<td class="highlight-min"');
          }
          return cell;
        }).join('');
        tbody.appendChild(tr);
      });

      window.playerData = playerData;
      const firstPlayer = Object.keys(playerData)[0];
      if (firstPlayer) viewPlayerDetail(firstPlayer);
    }
  </script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    .filter-box { max-width: 500px; margin: 10px auto; text-align: center; }
    .filter-box input { margin: 5px; padding: 8px; font-size: 14px; }
    .main-button { display: block; width: 100%; max-width: 300px; margin: 20px auto; padding: 15px; font-size: 18px; background-color: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; }
    .main-button:hover { background-color: #0056b3; }
    table { width: 100%; border-collapse: collapse; margin-top: 30px; background: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #e0e0e0; }
    .clickable-name { cursor: pointer; color: #007bff; text-decoration: underline; }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .player-detail { background-color: #e6f4ea; border-radius: 10px; padding: 20px; margin-top: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>総合成績 / 個人成績</h1>
  <div class="filter-box">
    <label>開始日：<input type="date" id="startDate"></label>
    <label>終了日：<input type="date" id="endDate"></label>
  </div>
  <button class="main-button" onclick="location.href='index.html'">ホームへ戻る</button>
  <table id="statsTable">
    <thead>
      <tr>
        <th>プレイヤー</th>
        <th>対局数</th>
        <th>合計ポイント</th>
        <th>1位回数</th>
        <th>2位回数</th>
        <th>3位回数</th>
        <th>4位回数</th>
        <th>トップ率</th>
        <th>連対率</th>
        <th>ラス回避率</th>
        <th>平均着順</th>
        <th>平均ポイント</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="playerDetail"></div>
</body>
</html>
