


<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-box {
      max-width: 500px;
      margin: 10px auto;
      text-align: center;
    }
    .filter-box input {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .main-button:hover {
      background-color: #0056b3;
    }
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px;
    }
    table {
      width: 100%;
      min-width: 1000px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
      font-weight: bold;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    small {
      display: block;
      color: #666;
      font-size: 0.8em;
    }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .clickable-name {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .player-detail {
      background-color: #e6f4ea;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .opponent-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    canvas {
      margin-top: 20px;
      max-width: 100%;
    }

    tr.low-sample td { background-color: #fafafa; color:#666; }
    tr.pair-selected td { background-color: #fff7d6; }
    tr.pair-selected td:first-child { background-color: #fff2b3; }

    /* 30åŠè˜æœªæº€ã‚°ãƒ«ãƒ¼ãƒ—ã®å¢ƒç•Œã‚’åˆ†ã‹ã‚Šã‚„ã™ã */
    tr.group-divider td{
      background: #e9eef7;
      color:#111827;
      font-weight: bold;
      text-align: left;
      padding: 10px 12px;
      border-top: 3px solid #94a3b8;
      border-bottom: 3px solid #94a3b8;
    }
    /* 30æœªæº€ã¯å°‘ã—ã ã‘è‰²å‘³ã‚’å¤‰ãˆã¦ã€Œåˆ¥ã‚°ãƒ«ãƒ¼ãƒ—æ„Ÿã€ã‚’å‡ºã™ */
    tr.low-sample td{
      background-color: #f7f7fb;
      color:#6b7280;
    }

    /* ã‚¹ãƒãƒ›å‘ã‘ï¼šä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .float-list-btn{
      position: fixed;
      right: 16px;
      bottom: 18px;
      z-index: 50;
      padding: 12px 14px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .float-list-btn:active{ transform: translateY(1px); }

    .modal-backdrop{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 60;
      padding: 14px;
    }
    .modal-backdrop.show{ display:block; }
    .modal{
      background: #fff;
      border-radius: 14px;
      max-width: 1200px;
      margin: 0 auto;
      height: calc(100vh - 28px);
      display:flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .modal-header .left{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .modal-header button{
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
    }
    .modal-body{
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background:#fff;
    }
    .modal-body .clone-wrap{
      padding: 10px;
      /* zoomã¯ãƒ–ãƒ©ã‚¦ã‚¶ä¾å­˜ã ã‘ã©ã€ã‚¹ãƒãƒ›ã§ã¯ç›´æ„Ÿçš„ã«åŠ¹ãã“ã¨ãŒå¤šã„ */
      zoom: var(--z, 0.9);
      transform-origin: top left;
    }

    @media (min-width: 721px){
      /* PCã§ã¯æµ®å‹•ãƒœã‚¿ãƒ³ã¯é‚ªé­”ã«ãªã‚Šã‚„ã™ã„ã®ã§éè¡¨ç¤º */
      .float-list-btn{ display:none; }
    }

    /* Pair filter responsive fix */
    #pairFilterBox .pair-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      align-items:center;
    }
    @media (max-width: 480px){
      #pairFilterBox .pair-row{
        flex-direction:column;
        align-items:stretch;
      }
      #pairFilterBox .pair-row strong{
        align-self:flex-start;
      }
      #pairFilterBox select,
      #pairFilterBox button{
        width:100%;
        max-width: 420px;
      }
      #pairFilterBox #pairStatus{
        align-self:flex-start;
      }
    }

  </style>
</head>
<body>
  <h1>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</h1>

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœãƒƒã‚¯ã‚¹ -->
  <div class="filter-box">
    <label>é–‹å§‹æ—¥ï¼š<input id="startDate" type="date"></label>
    <label>çµ‚äº†æ—¥ï¼š<input id="endDate" type="date"></label>
  </div>

  <!-- 2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div class="filter-box" id="pairFilterBox" style="max-width: 780px;">
    <div class="pair-row">
      <strong>2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼š</strong>
      <select id="pairA" style="padding:8px; font-size:14px;">
        <option value="">--ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼A--</option>
      </select>
      <select id="pairB" style="padding:8px; font-size:14px;">
        <option value="">--ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼B--</option>
      </select>
      <button id="applyPair" style="padding:10px 14px; font-size:14px; border:none; border-radius:10px; background:#111827; color:#fff; cursor:pointer;">ã“ã®2äººãŒåŒå“ã—ãŸåŠè˜ã®ã¿ã§è¡¨ç¤º</button>
      <button id="clearPair" style="padding:10px 14px; font-size:14px; border:1px solid #999; border-radius:10px; background:#fff; cursor:pointer;">è§£é™¤</button>
      <span id="pairStatus" style="color:#333; font-size:13px;"></span>
    </div>
    <small style="margin-top:6px;">â€»é¸ã‚“ã 2äººãŒåŒå“ã—ãŸåŠè˜ã ã‘ã§é›†è¨ˆã—ã€2äººã¯è¡¨ã®ä¸Šã«å›ºå®šã—ã¦å°‘ã—è‰²ã‚’å¤‰ãˆã¾ã™ã€‚</small>
  </div>

  <button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>

  <!-- ã‚¹ãƒãƒ›å‘ã‘ï¼šå…¨ä½“ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã -->
  <button id="openList" class="float-list-btn" type="button">ä¸€è¦§</button>

  <!-- é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« -->
  <div class="table-wrapper">
    <table id="statsTable">
      <thead>
        <tr>
          <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
          <th>å¯¾å±€æ•°</th>
          <th>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</th>
          <th>é †ä½ç‚¹ptåˆè¨ˆ</th>
          <th>1ä½</th>
          <th>2ä½</th>
          <th>3ä½</th>
          <th>4ä½</th>
          <th>ãƒˆãƒƒãƒ—ç‡</th>
          <th>é€£å¯¾ç‡</th>
          <th>ãƒ©ã‚¹å›é¿ç‡</th>
          <th>ã¨ã³ç‡</th>
          <th>å¹³å‡ç€é †</th>
          <th>å¹³å‡ç‚¹</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- è©³ç´°è¡¨ç¤ºé ˜åŸŸ -->
  <div id="playerDetail"></div>

  <!-- ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="listModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="æˆç¸¾ä¸€è¦§">
      <div class="modal-header">
        <div class="left">
          <strong>æˆç¸¾ä¸€è¦§ï¼ˆå…¨ä½“è¡¨ç¤ºï¼‰</strong>
          <label style="font-size:13px; color:#374151; display:flex; gap:8px; align-items:center;">
            ç¸®å°
            <input id="zoomRange" type="range" min="30" max="100" value="80" style="width:180px;">
            <span id="zoomLabel" style="min-width:44px; text-align:right;">80%</span>
          </label>
        </div>
        <button id="closeList" type="button">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modal-body">
        <div id="tableClone" class="clone-wrap"></div>
      </div>
    </div>
  </div>

  <script type="module">
    const MIN_GAMES_FOR_HIGHLIGHT = 30; // 30åŠè˜æœªæº€ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆé™¤å¤–
    // Firebase åˆæœŸåŒ–
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { collection as colSessions } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdceijbs690Dm28wjH3Y8fEMwW7gQ6bdk",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.appspot.com",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31",
      measurementId: "G-NP9EELBD7R"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    signInAnonymously(auth).catch(console.error);

    let allSessions = [];
    const playersMap = {};
    window.playerData = {};

    // 2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹
    let activePairA = '';
    let activePairB = '';

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åèª­ã¿è¾¼ã¿
    async function loadPlayerNames() {
      const snap = await getDocs(collection(db, "players"));
      snap.forEach(doc => {
        playersMap[doc.data().id] = doc.data().name;
      });
    }


    function populatePairSelectors() {
      const selA = document.getElementById("pairA");
      const selB = document.getElementById("pairB");
      if (!selA || !selB) return;

      // æ—¢å­˜optionï¼ˆå…ˆé ­ï¼‰ä»¥å¤–ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢
      selA.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());
      selB.querySelectorAll("option:not(:first-child)").forEach(o => o.remove());

      const ids = Object.keys(playersMap).sort((x,y) => (playersMap[x]||x).localeCompare(playersMap[y]||y, 'ja'));
      ids.forEach(id => {
        const optA = document.createElement("option");
        optA.value = id;
        optA.textContent = playersMap[id] || id;
        selA.appendChild(optA);

        const optB = document.createElement("option");
        optB.value = id;
        optB.textContent = playersMap[id] || id;
        selB.appendChild(optB);
      });
    }


    document.addEventListener("DOMContentLoaded", async () => {
      await loadPlayerNames();
      populatePairSelectors();

      // ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ï¼ˆã‚¹ãƒãƒ›ã§å…¨ä½“ã‚’è¦‹ã‚„ã™ãï¼‰
      const openBtn = document.getElementById('openList');
      const modal = document.getElementById('listModal');
      const closeBtn = document.getElementById('closeList');
      const zoomRange = document.getElementById('zoomRange');
      const zoomLabel = document.getElementById('zoomLabel');
      const cloneWrap = document.getElementById('tableClone');

      const setZoom = (pct) => {
        // ç¸®å°ã®ã¿ï¼ˆæ‹¡å¤§ã¯ä¸è¦ï¼‰
        const z = Math.max(30, Math.min(100, pct));
        if (cloneWrap) cloneWrap.style.setProperty('--z', (z/100).toFixed(2));
        if (zoomLabel) zoomLabel.textContent = `${z}%`;
        if (zoomRange) zoomRange.value = String(z);
      };

      // ç”»é¢å¹…ã«ã€Œã´ã£ãŸã‚Šå…¥ã‚‹ã€ç¸®å°ç‡ã‚’è¨ˆç®—ï¼ˆæ‹¡å¤§ã¯ã—ãªã„ï¼‰
      const autoFitZoom = () => {
        const mount = document.getElementById('tableClone');
        const body = modal?.querySelector('.modal-body');
        const tbl = mount?.querySelector('table');
        if (!mount || !body || !tbl) return null;
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ min-width ãŒã‚ã‚‹ã®ã§ scrollWidth ã‚’å„ªå…ˆ
        const tableW = tbl.scrollWidth || tbl.getBoundingClientRect().width;
        const bodyW = body.clientWidth - 20; // ä½™ç™½
        if (!tableW || !bodyW) return null;
        const fit = Math.floor((bodyW / tableW) * 100);
        return Math.max(30, Math.min(100, fit));
      };

      if (openBtn && modal) {
        openBtn.addEventListener('click', () => {
          refreshTableClone();
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
          // ã¾ãšã¯ã€Œæ¨ªå¹…ã´ã£ãŸã‚Šã€ã‚’å„ªå…ˆ
          const fit = autoFitZoom();
          if (fit != null) setZoom(fit);
          else setZoom(parseInt(zoomRange?.value || '80', 10));
        });
      }
      if (closeBtn && modal) {
        closeBtn.addEventListener('click', () => {
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
        });
      }
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
          }
        });
      }
      if (zoomRange) {
        zoomRange.addEventListener('input', () => setZoom(parseInt(zoomRange.value, 10)));
      }

      // ç«¯æœ«å›è»¢ãƒ»ãƒªã‚µã‚¤ã‚ºæ™‚ã‚‚ã€Œã´ã£ãŸã‚Šã€ã«å¯„ã›ã‚‹
      window.addEventListener('resize', () => {
        if (!modal?.classList.contains('show')) return;
        const fit = autoFitZoom();
        if (fit != null) setZoom(fit);
      });
      // Escã§é–‰ã˜ã‚‹
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal?.classList.contains('show')) {
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');
        }
      });

      document.getElementById("startDate").addEventListener("change", filterAndCalculate);
      document.getElementById("endDate").addEventListener("change", filterAndCalculate);

      document.getElementById("applyPair").addEventListener("click", () => {
        const a = document.getElementById("pairA").value;
        const b = document.getElementById("pairB").value;
        if (!a || !b || a === b) {
          document.getElementById("pairStatus").textContent = "â€»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’2äººï¼ˆåˆ¥ã€…ï¼‰é¸ã‚“ã§ãã ã•ã„";
          return;
        }
        activePairA = a;
        activePairB = b;
        document.getElementById("pairStatus").textContent = `é©ç”¨ä¸­ï¼š${playersMap[a] || a} Ã— ${playersMap[b] || b}`;
        filterAndCalculate();
      });

      document.getElementById("clearPair").addEventListener("click", () => {
        activePairA = '';
        activePairB = '';
        document.getElementById("pairA").value = '';
        document.getElementById("pairB").value = '';
        document.getElementById("pairStatus").textContent = '';
        filterAndCalculate();
      });

      onSnapshot(colSessions(db, "sessions"), snapshot => {
        allSessions = snapshot.docs.map(d => d.data());
        filterAndCalculate();
      });
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ â†’ é›†è¨ˆ â†’ æç”»
    function filterAndCalculate() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;

      const filtered = allSessions
        .map(sess => ({
          ...sess,
          games: sess.games.filter(g => {
            const inDate = (!start || g.date >= start) && (!end || g.date <= end);
            if (!inDate) return false;
            // 2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆä¸¡è€…ãŒåŒå“ã—ãŸåŠè˜ã®ã¿ï¼‰
            if (activePairA && activePairB) {
              const ids = g.players.map(x => x.id);
              return ids.includes(activePairA) && ids.includes(activePairB);
            }
            return true;
          })
        }))
        .filter(sess => sess.games.length > 0);

      calculateStats(filtered);
      renderTable();
    }

    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿è¨ˆç®—
    function calculateStats(sessions) {
      const rankPointMap = {1:50,2:10,3:-10,4:-30};
      const pd = {};

      sessions.sort((a,b) => new Date(a.title) - new Date(b.title));

      sessions.forEach(session => {
        session.games.forEach(game => {
          const sorted = [...game.players].sort((a,b) => b.point - a.point);

          sorted.forEach((p, idx) => {
            if (!pd[p.id]) pd[p.id] = {
              id: p.id,
              name: playersMap[p.id] || p.id,
              games: 0,
              tops: 0,
              seconds: 0,
              thirds: 0,
              fourths: 0,
              totalRank: 0,
              totalPoint: 0,
              totalRankPoint: 0,
              tobiCount: 0,
              pointHistory: [],
              rankHistory: [],
              dateHistory: [],
              vs: {},
              sessionHistory: [],
              sessionSums: []
            };
            const d = pd[p.id];
            const rank = idx + 1;
            const rankPt = rankPointMap[rank];
            const rawDiff = p.point - rankPt;

            
            // ã‚²ãƒ¼ãƒ ã”ã¨ã«
            if (p.point <= -60) {
              d.tobiCount++;
            }


            // åŸºæœ¬é›†è¨ˆ
            d.games++;
            d.totalPoint += p.point;
            d.totalRank += rank;
            d.totalRankPoint += rankPt;
            d.pointHistory.push(p.point);
            d.rankHistory.push(rank);

            // æ—¥ä»˜å±¥æ­´ï¼ˆã‚°ãƒ©ãƒ•ç”¨ï¼‰
            d.dateHistory.push(game.date || session.title || '');

            if (rank === 1)      d.tops++;
            else if (rank === 2) d.seconds++;
            else if (rank === 3) d.thirds++;
            else                  d.fourths++;

            // å¯¾æˆ¦ç›¸æ‰‹åˆ¥é›†è¨ˆ
            game.players.forEach(op => {
              if (op.id === p.id) return;
              if (!d.vs[op.id]) d.vs[op.id] = { games:0, wins:0, pointDiff:0 };
              d.vs[op.id].games++;
              d.vs[op.id].pointDiff += (p.point - op.point);
              if (p.point > op.point) d.vs[op.id].wins++;
            });
          });
        });

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ç™»éŒ²
        Object.keys(pd).forEach(pid => {
          const participated = session.games.some(g =>
            g.players.some(x => x.id === pid)
          );
          if (participated)
            pd[pid].sessionHistory.push(session);
        });
      });

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¯åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ
      Object.values(pd).forEach(p => {
        p.sessionSums = p.sessionHistory.map(sess =>
          sess.games.reduce((acc, gm) => {
            const me = gm.players.find(x => x.id === p.id);
            return acc + (me ? me.point : 0);
          }, 0)
        );
      });

      window.playerData = pd;
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    // ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦è¡¨ç¤º
    function refreshTableClone(){
      const mount = document.getElementById('tableClone');
      const src = document.getElementById('statsTable');
      if (!mount || !src) return;
      mount.innerHTML = '';
      const cloned = src.cloneNode(true);
      cloned.id = 'statsTableClone';
      cloned.style.marginTop = '0';
      // cloneå´ã¯ sticky ã‚’æ´»ã‹ã—ã¤ã¤ã€æ¨ªå¹…ã¯ãã®ã¾ã¾
      mount.appendChild(cloned);
    }

    function renderTable() {
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = '';

      // ã‚½ãƒ¼ãƒˆï¼šåŸºæœ¬ã¯åˆè¨ˆãƒã‚¤ãƒ³ãƒˆé †ã€‚ãŸã ã—30åŠè˜æœªæº€ã¯ä¸‹ã«å›ã™ï¼ˆ2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­ã¯é™¤ãï¼‰
      const players = Object.values(window.playerData)
        .map(p => {
          const avgDiff = (p.totalPoint - p.totalRankPoint) / p.games;
          p._avgFinal = 30000 + avgDiff * 1000;
          return p;
        })
        .sort((a, b) => {
          // 2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ™‚ã¯ã€é¸ã‚“ã 2äººã‚’æœ€ä¸Šæ®µã¸
          if (activePairA && activePairB) {
            const aSel = (a.id === activePairA || a.id === activePairB) ? 1 : 0;
            const bSel = (b.id === activePairA || b.id === activePairB) ? 1 : 0;
            if (aSel !== bSel) return bSel - aSel;
          } else {
            const aOK = a.games >= MIN_GAMES_FOR_HIGHLIGHT ? 1 : 0;
            const bOK = b.games >= MIN_GAMES_FOR_HIGHLIGHT ? 1 : 0;
            if (aOK !== bOK) return bOK - aOK; // 30æœªæº€ã¯ä¸‹ã¸
          }
          // åŒæ¡ä»¶å†…ã§ã¯åˆè¨ˆãƒã‚¤ãƒ³ãƒˆé †
          return b.totalPoint - a.totalPoint;
        });

      let dividerInserted = false;
      players.forEach(p => {
        // 30æœªæº€ã‚°ãƒ«ãƒ¼ãƒ—ã®ç›´å‰ã«åŒºåˆ‡ã‚Šï¼ˆ2äººå¯¾æˆ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä¸­ã¯å‡ºã•ãªã„ï¼‰
        if (!dividerInserted && !activePairA && !activePairB && p.games < MIN_GAMES_FOR_HIGHLIGHT) {
          const divTr = document.createElement('tr');
          divTr.className = 'group-divider';
          divTr.innerHTML = `<td colspan="14">30åŠè˜æœªæº€ï¼ˆå‚è€ƒï¼‰</td>`;
          tbody.appendChild(divTr);
          dividerInserted = true;
        }

        const avgDiff    = (p.totalPoint - p.totalRankPoint) / p.games;
        const avgFinal   = (30000 + avgDiff * 1000).toFixed(0);
        const avgRank    = (p.totalRank / p.games).toFixed(2);
        const topRate    = ((p.tops / p.games)*100).toFixed(1) + '%';
        const twoRate    = (((p.tops + p.seconds) / p.games)*100).toFixed(1) + '%';
        const avoidLast  = (((p.tops + p.seconds + p.thirds) / p.games)*100).toFixed(1) + '%';
        const tobiRate   = ((p.tobiCount / p.games)*100).toFixed(1) + '%';
        const topsRate   = (p.tops / p.games *100).toFixed(1) + '%';
        const secRate    = (p.seconds / p.games*100).toFixed(1) + '%';
        const thirdRate  = (p.thirds / p.games*100).toFixed(1) + '%';
        const fourRate   = (p.fourths / p.games*100).toFixed(1) + '%';

        const tr = document.createElement("tr");
        if (!activePairA && !activePairB && p.games < MIN_GAMES_FOR_HIGHLIGHT) tr.classList.add("low-sample");
        if (activePairA && activePairB && (p.id === activePairA || p.id === activePairB)) tr.classList.add("pair-selected");
        tr.innerHTML =
          `<td><span class="clickable-name" data-id="${p.id}">${p.name}</span></td>` +
          `<td>${p.games}</td>` +
          `<td>${p.totalPoint>=0?'+':''}${p.totalPoint.toFixed(1)}</td>` +
          `<td>${p.totalRankPoint>=0?'+':''}${p.totalRankPoint.toFixed(0)}</td>` +
          `<td>${p.tops}<br><small>${topsRate}</small></td>` +
          `<td>${p.seconds}<br><small>${secRate}</small></td>` +
          `<td>${p.thirds}<br><small>${thirdRate}</small></td>` +
          `<td>${p.fourths}<br><small>${fourRate}</small></td>` +
          `<td>${topRate}</td>` +
          `<td>${twoRate}</td>` +
          `<td>${avoidLast}</td>` +
          `<td>${tobiRate}</td>` +
          `<td>${avgRank}</td>` +
          `<td>${avgFinal}</td>`;
        tbody.appendChild(tr);
      });

      applyHighlighting();

      // ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚æ›´æ–°
      refreshTableClone();

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
      document.querySelectorAll(".clickable-name").forEach(el => {
        el.addEventListener("click", () => viewPlayerDetail(el.dataset.id));
      });
    }

    // æœ€å¤§/æœ€å°ãƒã‚¤ãƒ©ã‚¤ãƒˆ
   function applyHighlighting() {
  const table   = document.getElementById("statsTable");
  const rows    = Array.from(table.querySelectorAll("tbody tr")).filter(r => !r.classList.contains('group-divider'));
  const headers = Array.from(table.querySelectorAll("thead th")).map(th => th.textContent.trim());

  // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å–å¾—
  const gamesColIndex = headers.indexOf("å¯¾å±€æ•°");
  const skipHeaders = new Set(["ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼"]); // æ•°å€¤ã§ãªã„åˆ—ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆå¯¾è±¡å¤–

  headers.forEach((header, ci) => {
    if (skipHeaders.has(header)) return;

    // ã¾ãšå…¨ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å¤–ã™
    rows.forEach(r => r.cells[ci].classList.remove("highlight-max","highlight-min"));

    // é–¾å€¤ã‚’æº€ãŸã™è¡Œã ã‘ã‹ã‚‰å€¤ã‚’é›†ã‚ã‚‹
    const eligible = rows.map((r, i) => {
      const games = parseFloat(r.cells[gamesColIndex]?.textContent) || 0;
      if (games < MIN_GAMES_FOR_HIGHLIGHT) {
        return { i, eligible: false, v: null };
      }
      let v;
      if (["1ä½","2ä½","3ä½","4ä½"].includes(header)) {
        const sm = r.cells[ci].querySelector("small");
        v = sm ? parseFloat(sm.textContent) : NaN; // ã€Œxx.x%ã€ã®æ•°å€¤éƒ¨åˆ†
      } else {
        v = parseFloat(r.cells[ci].textContent);
      }
      return { i, eligible: !isNaN(v), v };
    });

    const vals = eligible.filter(e => e.eligible).map(e => e.v);
    if (vals.length < 2) return; // æ¯”è¼ƒå¯¾è±¡ãŒ1äººä»¥ä¸‹ãªã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ãªã„

    const max = Math.max(...vals);
    const min = Math.min(...vals);

    // é–¾å€¤ã‚’æº€ãŸã™è¡Œã«ã®ã¿ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
    rows.forEach((r, i) => {
      const games = parseFloat(r.cells[gamesColIndex]?.textContent) || 0;
      if (games < MIN_GAMES_FOR_HIGHLIGHT) return; // 30æœªæº€ã¯ä»˜ã‘ãªã„

      let v;
      if (["1ä½","2ä½","3ä½","4ä½"].includes(header)) {
        const sm = r.cells[ci].querySelector("small");
        v = sm ? parseFloat(sm.textContent) : NaN;
      } else {
        v = parseFloat(r.cells[ci].textContent);
      }
      if (isNaN(v)) return;

      const cell = r.cells[ci];
      if (header === "å¹³å‡ç€é †") {
        // å¹³å‡ç€é †ã¯å°ã•ã„æ–¹ãŒè‰¯ã„ï¼ˆæœ€å°=è‰¯ã„=é’ï¼‰
        if (v === min) cell.classList.add("highlight-max");
        if (v === max) cell.classList.add("highlight-min");
      } else {
        // ãã‚Œä»¥å¤–ã¯å¤§ãã„æ–¹ãŒè‰¯ã„ï¼ˆæœ€å¤§=è‰¯ã„=é’ï¼‰
        if (v === max) cell.classList.add("highlight-max");
        if (v === min) cell.classList.add("highlight-min");
      }
    });
  });
}


    // è©³ç´°è¡¨ç¤º
    window.viewPlayerDetail = function(pid) {
      const p = window.playerData[pid];
      if (!p) return;
      const div = document.getElementById("playerDetail");
      div.innerHTML = '';

      const avgDiffRaw = (p.totalPoint - p.totalRankPoint) / p.games;
      const avgDiff    = avgDiffRaw.toFixed(1);
      const avgFinal   = (30000 + avgDiffRaw * 1000).toFixed(0);
      const avgRank    = (p.totalRank/p.games).toFixed(2);
      const topRate    = ((p.tops/p.games)*100).toFixed(1);
      const avoidLast  = (((p.tops+p.seconds+p.thirds)/p.games)*100).toFixed(1);
      const maxPt      = Math.max(...p.pointHistory).toFixed(1);
      const minPt      = Math.min(...p.pointHistory).toFixed(1);
      let maxStreak    = 0, cur = 0;
      p.rankHistory.forEach(r => {
        if (r <= 2) { cur++; maxStreak = Math.max(maxStreak, cur); }
        else { cur = 0; }
      });
      const maxIdx     = p.sessionSums.indexOf(Math.max(...p.sessionSums));
      const minIdx     = p.sessionSums.indexOf(Math.min(...p.sessionSums));
      const maxText    = p.sessionSums.length && maxIdx !== -1 ? `${p.sessionSums[maxIdx].toFixed(1)} pt ï¼ˆ${p.sessionHistory[maxIdx].title}ï¼‰` : '-';
      const minText    = p.sessionSums.length && minIdx !== -1 ? `${p.sessionSums[minIdx].toFixed(1)} pt ï¼ˆ${p.sessionHistory[minIdx].title}ï¼‰` : '-';

      div.innerHTML = `
        <div class="player-detail">
          <h2>${p.name} ã®æˆç¸¾è©³ç´°</h2>
          <p>
            ğŸ€„ å¯¾å±€æ•°ï¼š${p.games} å›<br>
            ğŸ¯ åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼š${p.totalPoint.toFixed(1)} pt<br>
            ğŸ é †ä½ç‚¹ptåˆè¨ˆï¼š${p.totalRankPoint.toFixed(0)} pt<br>
            ğŸ“ˆ å¹³å‡å·®åˆ†ï¼š${avgDiff} pt<br>
            ğŸ¯ çµ‚å±€æ™‚å¹³å‡ç‚¹ï¼š${avgFinal} pt<br>
            ğŸ§® å¹³å‡ç€é †ï¼š${avgRank} ä½<br>
            ğŸ‘‘ ãƒˆãƒƒãƒ—ç‡ï¼š${topRate}%<br>
            ğŸš« ãƒ©ã‚¹å›é¿ç‡ï¼š${avoidLast}%<br>
            ğŸ›‘ ã¨ã³å›æ•°ï¼š${p.tobiCount} å›<br>
            ğŸ”„ æœ€é«˜é€£ç¶šé€£å¯¾æ•°ï¼š${maxStreak} å›<br>
            ğŸ”º æœ€å¤§å·®åˆ†ï¼š${maxPt} pt<br>
            ğŸ”» æœ€å°å·®åˆ†ï¼š${minPt} pt<br>
            ğŸ“Š æœ€é«˜1ã‚»ãƒƒãƒˆï¼š${maxText}<br>
            ğŸ“‰ æœ€ä½1ã‚»ãƒƒãƒˆï¼š${minText}
          </p>
          <canvas id="pointChart"></canvas>
          <div class="opponent-section">
            <label>å¯¾æˆ¦ç›¸æ‰‹ã‚’é¸æŠï¼š
              <select id="opponentSelect">
                <option value="">--é¸æŠ--</option>
                ${Object.keys(p.vs).sort().map(opp => `<option value="${opp}">${playersMap[opp] || opp}</option>`).join('')}
              </select>
            </label>
            <div id="opponentStats"></div>
          </div>
        </div>
      `;

      drawPointGraph(p);

      document.getElementById("opponentSelect").addEventListener("change", e => {
        const opp = e.target.value;
        const statsDiv = document.getElementById("opponentStats");
        statsDiv.innerHTML = '';
        if (!opp || !p.vs[opp]) return;
        const vs = p.vs[opp];
        const winRate = (vs.wins / vs.games * 100).toFixed(1);
        const avgDiffOpp = (vs.pointDiff / vs.games).toFixed(1);
        statsDiv.innerHTML = `
          <p>åŒå“å›æ•°ï¼š${vs.games} å›</p>
          <p>å‹åˆ©å›æ•°ï¼š${vs.wins} å› (${winRate}%)</p>
          <p>å¹³å‡ç‚¹å·®ï¼š${avgDiffOpp} pt</p>
        `;
      });
    };

    // ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•æç”»
    function drawPointGraph(p) {
      const cum = [];
      p.pointHistory.reduce((acc, cur) => {
        const next = acc + cur;
        cum.push(next.toFixed(1));
        return next;
      }, 0);
      const labels = cum.map((_, i) => {
        const d = (p.dateHistory && p.dateHistory[i]) ? String(p.dateHistory[i]) : '';
        // YYYY-MM-DD -> M/D ã«æ•´å½¢ï¼ˆå¤±æ•—ã—ãŸã‚‰ãã®ã¾ã¾ï¼‰
        let short = d;
        const m = d.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) short = `${parseInt(m[2],10)}/${parseInt(m[3],10)}`;
        return `${short} (#${i+1})`;
      });

      const ctx = document.getElementById("pointChart").getContext("2d");
      if (window._pointChartInstance) window._pointChartInstance.destroy();
      window._pointChartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆæ¨ç§»",
            data: cum,
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                title: (items) => {
                  const idx = items?.[0]?.dataIndex ?? 0;
                  const full = (p.dateHistory && p.dateHistory[idx]) ? String(p.dateHistory[idx]) : '';
                  return full ? `æ—¥ä»˜: ${full}` : `#${idx+1}`;
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: "å¯¾å±€æ•°" } },
            y: { title: { display: true, text: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ" } }
          }
        }
      });
    }
  </script>
</body>
</html>
