
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>総合成績 / 個人成績</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-box {
      max-width: 500px;
      margin: 10px auto;
      text-align: center;
    }
    .filter-box input {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .main-button:hover {
      background-color: #0056b3;
    }
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px;
    }
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
      font-weight: bold;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .clickable-name {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .player-detail {
      background-color: #e6f4ea;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .opponent-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    canvas {
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>
<h1>総合成績 / 個人成績</h1>
<div class="filter-box">
<label>開始日：<input id="startDate" type="date"/></label>
<label>終了日：<input id="endDate" type="date"/></label>
</div>
<button class="main-button" onclick="location.href='index.html'">ホームへ戻る</button>
<div class="table-wrapper">
<table id="statsTable">
<thead>
<tr>
<th>プレイヤー</th>
<th>対局数</th>
<th>合計ポイント</th>
<th>1位</th>
<th>2位</th>
<th>3位</th>
<th>4位</th>
<th>トップ率</th>
<th>連対率</th>
<th>ラス回避率</th>
<th>平均着順</th>
<th>平均点</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="playerDetail"></div>
<script type="module">
import { collection as col2, getDocs as getDocs2 } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
const playersMap = {};
async function loadPlayerNames() {
  const snap = await getDocs2(col2(db, "players"));
  snap.forEach(doc => {
    const data = doc.data();
    playersMap[data.id] = data.name;
  });
}


import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
  authDomain: "mahjong-app-2e2e9.firebaseapp.com",
  projectId: "mahjong-app-2e2e9",
  storageBucket: "mahjong-app-2e2e9.appspot.com",
  messagingSenderId: "440425002404",
  appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31",
  measurementId: "G-NP9EELBD7R"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let allSessions = [];

document.addEventListener("DOMContentLoaded", async () => {
  await loadPlayerNames();
  document.getElementById("startDate").addEventListener("change", filterAndCalculate);
  document.getElementById("endDate").addEventListener("change", filterAndCalculate);
  onSnapshot(collection(db, "sessions"), snapshot => {
    allSessions = [];
    snapshot.forEach(doc => allSessions.push(doc.data()));
    filterAndCalculate();
  });
});

function filterAndCalculate() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  const filtered = allSessions.map(s => ({
    ...s,
    games: s.games.filter(g => (!start || g.date >= start) && (!end || g.date <= end))
  })).filter(s => s.games.length > 0);
  calculateStats(filtered);
}

window.playerData = {};

function calculateStats(sessions) {
  const playerData = {};
  sessions.forEach(session => {
    session.games.forEach(game => {
      const sorted = [...game.players].sort((a, b) => b.point - a.point);
      sorted.forEach((p, i) => {
        if (!playerData[p.id]) {
          playerData[p.id] = {
          id: p.id,
          name: playersMap[p.id] || p.id,
            games: 0, tops: 0, seconds: 0, thirds: 0, fourths: 0,
            totalRank: 0, totalPoint: 0, pointHistory: [], rankHistory: [], vs: {}, sessionHistory: []
          };
        }
        const data = playerData[p.id];
        data.games++;
        if (i === 0) data.tops++;
        else if (i === 1) data.seconds++;
        else if (i === 2) data.thirds++;
        else if (i === 3) data.fourths++;

        data.totalRank += (i + 1);
        data.totalPoint += Number(p.point.toFixed(1));
        data.pointHistory.push(p.point);
        data.rankHistory.push(i + 1);
        game.players.forEach(op => {
          if (op.id === p.id) return;
          if (!data.vs[op.id]) {
            data.vs[op.id] = { games: 0, pointDiff: 0, wins: 0 };
          }
          data.vs[op.id].games++;
          data.vs[op.id].pointDiff += p.point - op.point;
          if (p.point > op.point) data.vs[op.id].wins++;
        });
      });
    });
    Object.keys(playerData).forEach(name => {
      const found = session.games.some(game => game.players.find(p => p.id === name));
      if (found) playerData[name].sessionHistory.push(session);
    });
  });

  window.playerData = playerData;

  const tbody = document.querySelector("#statsTable tbody");
  tbody.innerHTML = "";
  Object.values(playerData).forEach(p => {
    const avgRank = (p.totalRank / p.games).toFixed(2);
    const avgPoint = (p.totalPoint / p.games).toFixed(1);
    const topRate = ((p.tops / p.games) * 100).toFixed(1) + "%";
    const doubleRate = (((p.tops + p.seconds) / p.games) * 100).toFixed(1) + "%";
    const avoidLastRate = (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1) + "%";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="clickable-name" onclick="viewPlayerDetail('${playersMap[p.id] || p.id}')">${playersMap[p.id] || p.id}</span></td>
      <td>${p.games}</td>
      <td>${p.totalPoint >= 0 ? "+" : ""}${p.totalPoint.toFixed(1)}</td>
      <td>${p.tops}</td>
      <td>${p.seconds}</td>
      <td>${p.thirds}</td>
      <td>${p.fourths}</td>
      <td>${topRate}</td>
      <td>${doubleRate}</td>
      <td>${avoidLastRate}</td>
      <td>${avgRank}</td>
      <td>${avgPoint}</td>
    `;
    tbody.appendChild(tr);
  });

  applyHighlighting();
  const first = Object.keys(playerData)[0];
  if (first) viewPlayerDetail(first);
}

function applyHighlighting() {
  const table = document.getElementById('statsTable');
  const rows = table.querySelectorAll('tbody tr');
  const numCols = table.rows[0].cells.length;
  for (let col = 1; col < numCols; col++) {
    let max = -Infinity, min = Infinity;
    rows.forEach(row => {
      const val = parseFloat(row.cells[col].textContent);
      if (!isNaN(val)) {
        max = Math.max(max, val);
        min = Math.min(min, val);
      }
    });
    rows.forEach(row => {
      const cell = row.cells[col];
      const val = parseFloat(cell.textContent);
      cell.classList.remove('highlight-max', 'highlight-min');
      const headerText = table.rows[0].cells[col].textContent.trim();
      if (headerText === '平均着順') {
        if (val === min) cell.classList.add('highlight-max');
        if (val === max) cell.classList.add('highlight-min');
      } else {
        if (val === max) cell.classList.add('highlight-max');
        if (val === min) cell.classList.add('highlight-min');
      }
    });
  }
}

function calculateSessionSums(player) {
  if (!player.sessionSums && player.sessionHistory) {
    player.sessionSums = player.sessionHistory.map(session => {
      return session.games
        .map(game => {
          const me = game.players.find(p => p.name === player.name);
          return me ? me.point : 0;
        })
        .reduce((a, b) => a + b, 0);
    });
  }
}

window.viewPlayerDetail = function(name) {
  const p = window.playerData[name];
  if (!p) return;
  if (!p) return;

  const avgPoint = (p.totalPoint / p.games).toFixed(1);
  const avgRank = (p.totalRank / p.games).toFixed(2);
  const topRate = ((p.tops / p.games) * 100).toFixed(1);
  const avoidLastRate = (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1);

  const maxPoint = Math.max(...p.pointHistory).toFixed(1);
  const minPoint = Math.min(...p.pointHistory).toFixed(1);

  calculateSessionSums(p);
  const maxIdx = p.sessionSums ? p.sessionSums.indexOf(Math.max(...p.sessionSums)) : -1;
  const minIdx = p.sessionSums ? p.sessionSums.indexOf(Math.min(...p.sessionSums)) : -1;
  
  const maxSession = (p.sessionSums && maxIdx !== -1) ? 
   `${p.sessionSums[maxIdx].toFixed(1)} pt (${p.sessionHistory[maxIdx].title})` : "-";
  const minSession = (p.sessionSums && minIdx !== -1) ? 
   `${p.sessionSums[minIdx].toFixed(1)} pt (${p.sessionHistory[minIdx].title})` : "-";


  const opponents = Object.keys(p.vs).sort();
  const detailDiv = document.getElementById("playerDetail");

  detailDiv.innerHTML = `
    <div class="player-detail">
      <h2>${playersMap[p.id] || p.id} の成績詳細</h2>
      <p>
        🀄 対局数：${p.games} 回<br>
        🎯 合計ポイント：${p.totalPoint.toFixed(1)} pt<br>
        📈 平均ポイント：${avgPoint} pt<br>
        🧮 平均着順：${avgRank} 位<br>
        👑 トップ率：${topRate}%<br>
        🚫 ラス回避率：${avoidLastRate}%<br>
        🔺 1半荘での最大獲得pt：${maxPoint} pt<br>
        🔻 1半荘での最小獲得pt：${minPoint} pt<br>
        📊 1日(1セット)での最高成績：${maxSession} pt<br>
        📉 1日(1セット)での最低成績：${minSession} pt<br>
      </p>
      <canvas id="pointChart"></canvas>
      <div class="opponent-section">
        <label>対戦相手を選択：
          <select id="opponentSelect">
            <option value="">--選択してください--</option>
            ${opponents.map(opId => `<option value="${opId}">${playersMap[opId] || opId}</option>`).join('')}
          </select>
        </label>
        <div id="opponentStats"></div>
      </div>
    </div>
  `;

  drawPointGraph(p);

  document.getElementById("opponentSelect").addEventListener("change", e => {
    const opName = e.target.value;
    const vs = p.vs[opName];
    const statsDiv = document.getElementById("opponentStats");
    if (!opName || !vs) {
      statsDiv.innerHTML = "";
      return;
    }
    const avgDiff = (vs.pointDiff / vs.games).toFixed(1);
    const winRate = ((vs.wins / vs.games) * 100).toFixed(1);
    statsDiv.innerHTML = `
      <p>
        📊 ${playersMap[p.id] || p.id} vs ${opName}<br>
        🔁 同卓回数：${vs.games} 回<br>
        🥇 勝利回数：${vs.wins} 回 (${winRate}%)<br>
        ⚖️ 平均点差：${avgDiff} pt
      </p>
    `;
  });
};

function drawPointGraph(p) {
  const pointData = p.pointHistory.map(v => Number(v.toFixed(1)));
  const ctx = document.getElementById("pointChart").getContext("2d");
  new Chart(ctx, {
    type: "line",
    data: {
      labels: pointData.map((_, i) => i + 1),
      datasets: [{
        label: "累積ポイント推移",
        data: pointData,
        borderColor: "blue",
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: "対局数" } },
        y: { title: { display: true, text: "累積ポイント" } }
      }
    }
  });
}
</script>
</body>
</html>
