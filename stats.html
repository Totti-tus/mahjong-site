<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-box {
      max-width: 500px;
      margin: 10px auto;
      text-align: center;
    }
    .filter-box input {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .main-button:hover { background-color: #0056b3; }
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px;
    }
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
      font-weight: bold;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .clickable-name {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .player-detail {
      background-color: #e6f4ea;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .opponent-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    canvas {
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h1>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</h1>

  <div class="filter-box">
    <label>é–‹å§‹æ—¥ï¼š<input id="startDate" type="date" /></label>
    <label>çµ‚äº†æ—¥ï¼š<input id="endDate" type="date" /></label>
  </div>
  <button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>

  <div class="table-wrapper">
    <table id="statsTable">
      <thead>
        <tr>
          <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
          <th>å¯¾å±€æ•°</th>
          <th>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</th>
          <th>1ä½</th>
          <th>2ä½</th>
          <th>3ä½</th>
          <th>4ä½</th>
          <th>ãƒˆãƒƒãƒ—ç‡</th>
          <th>é€£å¯¾ç‡</th>
          <th>ãƒ©ã‚¹å›é¿ç‡</th>
          <th>å¹³å‡ç€é †</th>
          <th>å¹³å‡ç‚¹</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="playerDetail"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { collection as colSessions } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { /* Your config */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(); signInAnonymously(auth).catch(console.error);

    let allSessions = [], playersMap = {}, window.playerData = {};

    async function loadPlayerNames() {
      const snap = await getDocs(collection(db, "players"));
      snap.forEach(doc => playersMap[doc.data().id] = doc.data().name);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadPlayerNames();
      document.getElementById("startDate").addEventListener("change", filterAndCalculate);
      document.getElementById("endDate").addEventListener("change", filterAndCalculate);
      onSnapshot(colSessions(db, "sessions"), snap => { allSessions = snap.docs.map(d => d.data()); filterAndCalculate(); });
    });

    function filterAndCalculate() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const filtered = allSessions.map(sess => ({
        ...sess,
        games: sess.games.filter(g => (!start || g.date >= start) && (!end || g.date <= end))
      })).filter(sess => sess.games.length);
      calculateStats(filtered);
      renderTable();
    }

    function calculateStats(sessions) {
      const rankPointMap = {1:50,2:10,3:-10,4:-30};
      const pd = {};
      // ã‚½ãƒ¼ãƒˆï¼šå¤ã„é †
      sessions.sort((a, b) => new Date(a.title) - new Date(b.title));
      sessions.forEach(session => {
        session.games.forEach(game => {
          const sorted = [...game.players].sort((a, b) => b.point - a.point);
          sorted.forEach((p, idx) => {
            if (!pd[p.id]) pd[p.id] = {id:p.id,name:playersMap[p.id]||p.id,games:0,tops:0,seconds:0,thirds:0,fourths:0,totalRank:0,totalPoint:0,totalRankPoint:0,pointHistory:[],rankHistory:[],vs:{},sessionHistory:[],sessionSums:[]};
            const d = pd[p.id], rank = idx+1, rankPt = rankPointMap[rank];
            d.games++; d.totalPoint += p.point; d.totalRank += rank; d.totalRankPoint += rankPt;
            d.pointHistory.push(p.point); d.rankHistory.push(rank);
            rank===1?d.tops++:rank===2?d.seconds++:rank===3?d.thirds++:d.fourths++;
            game.players.forEach(op => {
              if (op.id===p.id) return;
              if (!d.vs[op.id]) d.vs[op.id] = {games:0,wins:0,pointDiff:0};
              d.vs[op.id].games++; d.vs[op.id].pointDiff += (p.point-op.point);
              if (p.point>op.point) d.vs[op.id].wins++;
            });
          });
        });
        Object.keys(pd).forEach(pid => {
          if (session.games.some(gm => gm.players.some(x=>x.id===pid))) pd[pid].sessionHistory.push(session);
        });
      });
      Object.values(pd).forEach(p => {
        p.sessionSums = p.sessionHistory.map(sess => sess.games.reduce((acc,gm) => { const me = gm.players.find(x=>x.id===p.id); return acc + (me?me.point:0); }, 0));
      });
      window.playerData = pd;
    }

    function renderTable() {
      const tbody = document.querySelector("#statsTable tbody"); tbody.innerHTML = '';
      Object.values(window.playerData).forEach(p => {
        const avgRaw    = p.totalPoint / p.games;
        const avgRankPt = p.totalRankPoint / p.games;
        const combined  = avgRaw + avgRankPt;
        const avgFinal  = (30000 + combined * 1000).toFixed(0);
        const avgRank   = (p.totalRank / p.games).toFixed(2);
        const topRate   = ((p.tops / p.games) * 100).toFixed(1) + "%";
        const twoRate   = (((p.tops + p.seconds) / p.games) * 100).toFixed(1) + "%";
        const avoidLast = (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1) + "%";
        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td><span class="clickable-name" data-id="${p.id}">${p.name}</span></td>` +
          `<td>${p.games}</td>` +
          `<td>${p.totalPoint>=0?'+':''}${p.totalPoint.toFixed(1)}</td>` +
          `<td>${p.tops}</td><td>${p.seconds}</td><td>${p.thirds}</td><td>${p.fourths}</td>` +
          `<td>${topRate}</td><td>${twoRate}</td><td>${avoidLast}</td>` +
          `<td>${avgRank}</td><td>${avgFinal}</td>`;
        tbody.appendChild(tr);
      });
      applyHighlighting();
      document.querySelectorAll(".clickable-name").forEach(el => el.addEventListener("click", () => viewPlayerDetail(el.dataset.id)));
      const firstId = Object.keys(window.playerData)[0]; if (firstId) viewPlayerDetail(firstId);
    }

    function applyHighlighting() {
      const table = document.getElementById("statsTable"), rows = Array.from(table.querySelectorAll("tbody tr"));
      for (let c = 1; c < table.rows[0].cells.length; c++) {
        let max=-Infinity, min=Infinity;
        rows.forEach(r => { const v=parseFloat(r.cells[c].textContent); if(!isNaN(v)){max=Math.max(max,v);min=Math.min(min,v);} });
        rows.forEach(r => { const cell=r.cells[c], v=parseFloat(cell.textContent), h=table.rows[0].cells[c].textContent.trim(); cell.classList.remove("highlight-max","highlight-min"); if(!isNaN(v)){ if(h==="å¹³å‡ç€é †"){ if(v===min)cell.classList.add("highlight-max"); if(v===max)cell.classList.add("highlight-min"); } else { if(v===max)cell.classList.add("highlight-max"); if(v===min)cell.classList.add("highlight-min"); } } });
      }
    }

    window.viewPlayerDetail = function(pid) {
      const p = window.playerData[pid]; if (!p) return;
      const div = document.getElementById("playerDetail"); div.innerHTML = '';
      const avgRaw    = (p.totalPoint / p.games).toFixed(1);
      const avgRankPt = (p.totalRankPoint / p.games).toFixed(1);
      const avgFinal  = (30000 + (parseFloat(avgRaw)+parseFloat(avgRankPt)) * 1000).toFixed(0);
      const avgRank   = (p.totalRank / p.games).toFixed(2);
      const topRate   = ((p.tops / p.games) * 100).toFixed(1);
      const avoidLast = (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1);
      const maxPt     = Math.max(...p.pointHistory).toFixed(1);
      const minPt     = Math.min(...p.pointHistory).toFixed(1);
      const maxIdx    = p.sessionSums.indexOf(Math.max(...p.sessionSums));
      const minIdx    = p.sessionSums.indexOf(Math.min(...p.sessionSums));
      const maxText   = p.sessionSums.length&&maxIdx!==-1?`${p.sessionSums[maxIdx].toFixed(1)} pt ( ${p.sessionHistory[maxIdx].title} )` : '-';
      const minText   = p.sessionSums.length&&minIdx!==-1?`${p.sessionSums[minIdx].toFixed(1)} pt ( ${p.sessionHistory[minIdx].title} )` : '-';
      div.innerHTML = `
        <div class="player-detail">
          <h2>${p.name} ã®æˆç¸¾è©³ç´°</h2>
          <p>ğŸ€„ å¯¾å±€æ•°ï¼š${p.games} å›<br>
             ğŸ¯ åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼š${p.totalPoint.toFixed(1)} pt<br>
             ğŸ“ˆ å¹³å‡å·®åˆ†ï¼š${avgRaw} pt<br>
             ğŸ… å¹³å‡é †ä½ç‚¹ï¼š${avgRankPt} pt<br>
             ğŸ¯ çµ‚å±€æ™‚å¹³å‡ç‚¹ï¼š${avgFinal} pt<br>
             ğŸ§® å¹³å‡ç€é †ï¼š${avgRank} ä½<br>
             ğŸ‘‘ ãƒˆãƒƒãƒ—ç‡ï¼š${topRate}%<br>
             ğŸš« ãƒ©ã‚¹å›é¿ç‡ï¼š${avoidLast}%<br>
             ğŸ”º æœ€å¤§å·®åˆ†ï¼š${maxPt} pt<br>
             ğŸ”» æœ€å°å·®åˆ†ï¼š${minPt} pt<br>
             ğŸ“Š æœ€é«˜1ã‚»ãƒƒãƒˆï¼š${maxText}<br>
             ğŸ“‰ æœ€ä½1ã‚»ãƒƒãƒˆï¼š${minText}
          </p>
          <canvas id="pointChart"></canvas>
          <div class="opponent-section">
            <label>å¯¾æˆ¦ç›¸æ‰‹ã‚’é¸æŠï¼š<select id="opponentSelect"><option value="">--é¸æŠ--</option>${Object.keys(p.vs).sort().map(opp=>`<option value="${opp}">${playersMap[opp]||opp}</option>`).join('')}</select></label>
            <div id="opponentStats"></div>
          </div>
        </div>
      `;
      drawPointGraph(p);
      document.getElementById("opponentSelect").addEventListener("change", e => {
        const opp = e.target.value; const statsDiv = document.getElementById("opponentStats"); statsDiv.innerHTML='';
        if (!opp || !p.vs[opp]) return;
        const vs = p.vs[opp], winRate=(vs.wins/vs.games*100).toFixed(1), avgDiff=(vs.pointDiff/vs.games).toFixed(1);
        statsDiv.innerHTML = `<p>åŒå“å›æ•°ï¼š${vs.games} å›<br>å‹åˆ©å›æ•°ï¼š${vs.wins} å› (${winRate}%)<br>å¹³å‡ç‚¹å·®ï¼š${avgDiff} pt</p>`;
      });
    };

    function drawPointGraph(p) {
      // å¤ã„å¯¾å±€ã‹ã‚‰é †ã«ç´¯ç©
      const cum = [];
      p.pointHistory.reduce((acc, cur) => {
        const next = acc + cur;
        cum.push(next.toFixed(1));
        return next;
      }, 0);
      const labels = cum.map((_, i) => `#${i+1}`);

      const ctx = document.getElementById("pointChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆæ¨ç§»", data: cum, fill: false, tension: 0.1 }] },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "å¯¾å±€æ•°" } },
            y: { title: { display: true, text: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ" } }
          }
        }
      });
    }
  </script>
</body>
</html>
