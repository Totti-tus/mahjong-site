
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-box {
      max-width: 500px;
      margin: 10px auto;
      text-align: center;
    }
    .filter-box input {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .main-button:hover {
      background-color: #0056b3;
    }
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px;
    }
    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
      font-weight: bold;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .clickable-name {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .player-detail {
      background-color: #e6f4ea;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .opponent-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    canvas {
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>
<h1>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</h1>
<div class="filter-box">
<label>é–‹å§‹æ—¥ï¼š<input id="startDate" type="date"/></label>
<label>çµ‚äº†æ—¥ï¼š<input id="endDate" type="date"/></label>
</div>
<button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
<div class="table-wrapper">
<table id="statsTable">
<thead>
<tr>
<th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
<th>å¯¾å±€æ•°</th>
<th>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</th>
<th>1ä½</th>
<th>2ä½</th>
<th>3ä½</th>
<th>4ä½</th>
<th>ãƒˆãƒƒãƒ—ç‡</th>
<th>é€£å¯¾ç‡</th>
<th>ãƒ©ã‚¹å›é¿ç‡</th>
<th>å¹³å‡ç€é †</th>
<th>å¹³å‡ç‚¹</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div id="playerDetail"></div>
<script type="module">
  // â€”â€” Firebase åˆæœŸåŒ– â€”â€” 
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
    authDomain: "mahjong-app-2e2e9.firebaseapp.com",
    projectId: "mahjong-app-2e2e9",
    storageBucket: "mahjong-app-2e2e9.appspot.com",
    messagingSenderId: "440425002404",
    appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // åŒ¿åèªè¨¼ â†’ èªè¨¼å®Œäº†å¾Œã ã‘ Firestore æ“ä½œã‚’é–‹å§‹
  signInAnonymously(auth)
    .then(() => console.log("ğŸ”‘ åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"))
    .catch(err => console.error("âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", err.message));

  onAuthStateChanged(auth, user => {
    if (user) console.log("ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user.uid);
    else     console.log("ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­");
  });

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åãƒãƒƒãƒ—èª­ã¿è¾¼ã¿
  const playersMap = {};
  async function loadPlayerNames() {
    const snap = await getDocs(collection(db, "players"));
    snap.forEach(doc => {
      const d = doc.data();
      playersMap[d.id] = d.name;
    });
  }

  // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
  let allSessions = [];

  // DOM æº–å‚™å®Œäº†å¾Œã«èª­ã¿è¾¼ã¿ â†’ ãƒ•ã‚£ãƒ«ã‚¿ â†’ æç”»
  document.addEventListener("DOMContentLoaded", async () => {
    await loadPlayerNames();
    // æ—¥ä»˜å¤‰æ›´ã§å†è¨ˆç®—
    document.getElementById("startDate").addEventListener("change", filterAndCalculate);
    document.getElementById("endDate").addEventListener("change", filterAndCalculate);
    // Firestore ã®ãƒ©ã‚¤ãƒ–æ›´æ–°ã‚’ç›£è¦–
    onSnapshot(collection(db, "sessions"), snapshot => {
      allSessions = [];
      snapshot.forEach(doc => allSessions.push(doc.data()));
      filterAndCalculate();
    });
  });

  // ãƒ•ã‚£ãƒ«ã‚¿ï¼†è©³ç´°çµ±è¨ˆè¨ˆç®—å‘¼ã³å‡ºã—
  function filterAndCalculate() {
    const start = document.getElementById("startDate").value;
    const end   = document.getElementById("endDate").value;
    const filtered = allSessions
      .map(s => ({
        ...s,
        games: s.games.filter(g => (!start || g.date >= start) && (!end || g.date <= end))
      }))
      .filter(s => s.games.length > 0);
    calculateStats(filtered);
  }

  // çµ±è¨ˆå€¤è¨ˆç®—ï¼‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼è©³ç´°æç”»
  function calculateStats(sessions) {
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã®é›†è¨ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const playerData = {};
    sessions.forEach(session => {
      session.games.forEach(game => {
        // ç€é †ã‚½ãƒ¼ãƒˆ
        const sorted = [...game.players].sort((a, b) => b.point - a.point);
        sorted.forEach((p, i) => {
          if (!playerData[p.id]) {
            playerData[p.id] = {
              id: p.id,
              name: playersMap[p.id] || p.id,
              games: 0, tops: 0, seconds: 0, thirds: 0, fourths: 0,
              totalRank: 0, totalPoint: 0,
              pointHistory: [], rankHistory: [],
              vs: {}, sessionHistory: [], sessionSums: []
            };
          }
          const d = playerData[p.id];
          d.games++;
          if (i === 0)      d.tops++;
          else if (i === 1) d.seconds++;
          else if (i === 2) d.thirds++;
          else if (i === 3) d.fourths++;
          d.totalRank += i + 1;
          d.totalPoint += p.point;
          d.pointHistory.push(p.point);
          d.rankHistory.push(i + 1);
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®åˆè¨ˆç‚¹
          const sumThisSession = game.players.find(pl => pl.id === p.id).point;
          d.sessionSums.push(sumThisSession);
          d.sessionHistory.push({ title: session.title });
          // å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡
          game.players.forEach(op => {
            if (op.id !== p.id) {
              d.vs[op.id] = (d.vs[op.id] || 0) + (p.point >= 0 ? 1 : 0);
            }
          });
        });
      });
    });

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†æ§‹ç¯‰ï¼‰
    const table = document.getElementById("statsTable");
    table.querySelectorAll("tr:not(:first-child)").forEach(tr => tr.remove());
    Object.values(playerData).forEach(p => {
      const avgPoint       = (p.totalPoint / p.games).toFixed(1);
      const avgRank        = (p.totalRank  / p.games).toFixed(2);
      const topRate        = ((p.tops / p.games) * 100).toFixed(1);
      const avoidLastRate  = (((p.games - p.fourths) / p.games) * 100).toFixed(1);
      const maxPoint       = Math.max(...p.pointHistory).toFixed(1);
      const minPoint       = Math.min(...p.pointHistory).toFixed(1);
      const maxIdx         = p.sessionSums.indexOf(Math.max(...p.sessionSums));
      const minIdx         = p.sessionSums.indexOf(Math.min(...p.sessionSums));
      const maxSession     = maxIdx !== -1
        ? `${p.sessionSums[maxIdx].toFixed(1)} pt (${p.sessionHistory[maxIdx].title})`
        : "-";
      const minSession     = minIdx !== -1
        ? `${p.sessionSums[minIdx].toFixed(1)} pt (${p.sessionHistory[minIdx].title})`
        : "-";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${p.name}</td>
        <td>${p.games}</td>
        <td>${p.totalPoint.toFixed(1)}</td>
        <td>${avgPoint}</td>
        <td>${avgRank}</td>
        <td>${topRate}%</td>
        <td>${avoidLastRate}%</td>
        <td>${maxPoint}</td>
        <td>${minPoint}</td>
        <td>${maxSession}</td>
        <td>${minSession}</td>
      `;
      table.appendChild(row);
    });

    // è©³ç´°æˆç¸¾è¡¨ç¤ºã‚¨ãƒªã‚¢æ›´æ–°
    // ï¼ˆã‚°ãƒ©ãƒ•æç”»ï¼†å¯¾æˆ¦ç›¸æ‰‹é¸æŠãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    const detailDiv = document.getElementById("playerDetail");
    detailDiv.innerHTML = "";  // ã¾ãšã‚¯ãƒªã‚¢
    Object.values(playerData).forEach(p => {
      const container = document.createElement("div");
      container.className = "player-detail";
      container.innerHTML = `
        <h2>${p.name} ã®æˆç¸¾è©³ç´°</h2>
        <p>
          ğŸ€„ å¯¾å±€æ•°ï¼š${p.games} å›<br>
          ğŸ¯ åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼š${p.totalPoint.toFixed(1)} pt<br>
          ğŸ“ˆ å¹³å‡ãƒã‚¤ãƒ³ãƒˆï¼š${avgPoint} pt<br>
          ğŸ§® å¹³å‡ç€é †ï¼š${avgRank} ä½<br>
          ğŸ‘‘ ãƒˆãƒƒãƒ—ç‡ï¼š${topRate}%<br>
          ğŸš« ãƒ©ã‚¹å›é¿ç‡ï¼š${avoidLastRate}%<br>
          ğŸ”º 1åŠè˜ã§ã®æœ€å¤§ç²å¾—ptï¼š${maxPoint} pt<br>
          ğŸ”» 1åŠè˜ã§ã®æœ€å°ç²å¾—ptï¼š${minPoint} pt<br>
          ğŸ“Š 1æ—¥(1ã‚»ãƒƒãƒˆ)ã§ã®æœ€é«˜æˆç¸¾ï¼š${maxSession}<br>
          ğŸ“‰ 1æ—¥(1ã‚»ãƒƒãƒˆ)ã§ã®æœ€ä½æˆç¸¾ï¼š${minSession}<br>
        </p>
        <canvas id="pointChart-${p.id}" height="150"></canvas>
        <div class="opponent-section">
          <label>å¯¾æˆ¦ç›¸æ‰‹ã‚’é¸æŠï¼š
            <select id="opponentSelect-${p.id}">
              <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
            </select>
          </label>
        </div>
      `;
      detailDiv.appendChild(container);

      // ç´¯ç©ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ãƒãƒ£ãƒ¼ãƒˆ
      const ctx = document.getElementById(`pointChart-${p.id}`).getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: p.rankHistory.map((_, i) => i+1),
          datasets: [{
            label: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ",
            data: p.sessionSums.reduce((acc, cur, i) => {
              acc.push((i>0 ? acc[i-1] : 0) + cur);
              return acc;
            }, []),
            fill: false
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "å¯¾å±€æ•°" } },
            y: { title: { display: true, text: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ" } }
          }
        }
      });

      // å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹ç‡ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
      const sel = document.getElementById(`opponentSelect-${p.id}`);
      Object.keys(p.vs).sort().forEach(oppId => {
        const opt = document.createElement("option");
        opt.value = oppId;
        opt.textContent = `${playersMap[oppId]||oppId} (å‹åˆ©:${p.vs[oppId]}å›)`;
        sel.appendChild(opt);
      });
    });
  }
</script>

</body>
</html>
