<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>総合成績 / 個人成績</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-box {
      max-width: 500px;
      margin: 10px auto;
      text-align: center;
    }
    .filter-box input {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .main-button:hover {
      background-color: #0056b3;
    }
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 10px;
    }
    table {
      width: 100%;
      min-width: 1000px;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
      font-weight: bold;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    small {
      display: block;
      color: #666;
      font-size: 0.8em;
    }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .clickable-name {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .player-detail {
      background-color: #e6f4ea;
      border-radius: 10px;
      padding: 20px;
      margin-top: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .opponent-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    canvas {
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h1>総合成績 / 個人成績</h1>

  <!-- フィルターボックス -->
  <div class="filter-box">
    <label>開始日：<input id="startDate" type="date"></label>
    <label>終了日：<input id="endDate" type="date"></label>
  </div>
  <button class="main-button" onclick="location.href='index.html'">ホームへ戻る</button>

  <!-- 集計テーブル -->
  <div class="table-wrapper">
    <table id="statsTable">
      <thead>
        <tr>
          <th>プレイヤー</th>
          <th>対局数</th>
          <th>合計ポイント</th>
          <th>1位</th>
          <th>2位</th>
          <th>3位</th>
          <th>4位</th>
          <th>トップ率</th>
          <th>連対率</th>
          <th>ラス回避率</th>
          <th>とび率</th>
          <th>平均着順</th>
          <th>平均点</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- 詳細表示領域 -->
  <div id="playerDetail"></div>

  <script type="module">
    // Firebase 初期化
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { collection as colSessions } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.appspot.com",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31",
      measurementId: "G-NP9EELBD7R"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    signInAnonymously(auth).catch(console.error);

    let allSessions = [];
    const playersMap = {};
    window.playerData = {};

    // プレイヤー名読み込み
    async function loadPlayerNames() {
      const snap = await getDocs(collection(db, "players"));
      snap.forEach(doc => {
        playersMap[doc.data().id] = doc.data().name;
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadPlayerNames();

      document.getElementById("startDate").addEventListener("change", filterAndCalculate);
      document.getElementById("endDate").addEventListener("change", filterAndCalculate);

      onSnapshot(colSessions(db, "sessions"), snapshot => {
        allSessions = snapshot.docs.map(d => d.data());
        filterAndCalculate();
      });
    });

    // フィルター → 集計 → 描画
    function filterAndCalculate() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;

      const filtered = allSessions
        .map(sess => ({
          ...sess,
          games: sess.games.filter(g => (!start || g.date >= start) && (!end || g.date <= end))
        }))
        .filter(sess => sess.games.length > 0);

      calculateStats(filtered);
      renderTable();
    }

    // 統計データ計算
    function calculateStats(sessions) {
      const rankPointMap = {1:50,2:10,3:-10,4:-30};
      const pd = {};

      sessions.sort((a,b) => new Date(a.title) - new Date(b.title));

      sessions.forEach(session => {
        session.games.forEach(game => {
          const sorted = [...game.players].sort((a,b) => b.point - a.point);

          sorted.forEach((p, idx) => {
            if (!pd[p.id]) pd[p.id] = {
              id: p.id,
              name: playersMap[p.id] || p.id,
              games: 0,
              tops: 0,
              seconds: 0,
              thirds: 0,
              fourths: 0,
              totalRank: 0,
              totalPoint: 0,
              totalRankPoint: 0,
              tobiCount: 0,
              pointHistory: [],
              rankHistory: [],
              vs: {},
              sessionHistory: [],
              sessionSums: []
            };
            const d = pd[p.id];
            const rank = idx + 1;
            const rankPt = rankPointMap[rank];
            const rawDiff = p.point - rankPt;

            
            // ゲームごとに
            if (p.point <= -60) {
              d.tobiCount++;
            }


            // 基本集計
            d.games++;
            d.totalPoint += p.point;
            d.totalRank += rank;
            d.totalRankPoint += rankPt;
            d.pointHistory.push(p.point);
            d.rankHistory.push(rank);

            if (rank === 1)      d.tops++;
            else if (rank === 2) d.seconds++;
            else if (rank === 3) d.thirds++;
            else                  d.fourths++;

            // 対戦相手別集計
            game.players.forEach(op => {
              if (op.id === p.id) return;
              if (!d.vs[op.id]) d.vs[op.id] = { games:0, wins:0, pointDiff:0 };
              d.vs[op.id].games++;
              d.vs[op.id].pointDiff += (p.point - op.point);
              if (p.point > op.point) d.vs[op.id].wins++;
            });
          });
        });

        // セッション履歴登録
        Object.keys(pd).forEach(pid => {
          const participated = session.games.some(g =>
            g.players.some(x => x.id === pid)
          );
          if (participated)
            pd[pid].sessionHistory.push(session);
        });
      });

      // セッション毎合計ポイント
      Object.values(pd).forEach(p => {
        p.sessionSums = p.sessionHistory.map(sess =>
          sess.games.reduce((acc, gm) => {
            const me = gm.players.find(x => x.id === p.id);
            return acc + (me ? me.point : 0);
          }, 0)
        );
      });

      window.playerData = pd;
    }

    // テーブル描画
    function renderTable() {
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = '';

      // 平均点順でソート
      const players = Object.values(window.playerData)
        .map(p => {
          const avgDiff = (p.totalPoint - p.totalRankPoint) / p.games;
          p._sortKey = 30000 + avgDiff * 1000;
          return p;
        })
        .sort((a, b) => b.totalPoint - a.totalPoint);

      players.forEach(p => {
        const avgDiff    = (p.totalPoint - p.totalRankPoint) / p.games;
        const avgFinal   = (30000 + avgDiff * 1000).toFixed(0);
        const avgRank    = (p.totalRank / p.games).toFixed(2);
        const topRate    = ((p.tops / p.games)*100).toFixed(1) + '%';
        const twoRate    = (((p.tops + p.seconds) / p.games)*100).toFixed(1) + '%';
        const avoidLast  = (((p.tops + p.seconds + p.thirds) / p.games)*100).toFixed(1) + '%';
        const tobiRate   = ((p.tobiCount / p.games)*100).toFixed(1) + '%';
        const topsRate   = (p.tops / p.games *100).toFixed(1) + '%';
        const secRate    = (p.seconds / p.games*100).toFixed(1) + '%';
        const thirdRate  = (p.thirds / p.games*100).toFixed(1) + '%';
        const fourRate   = (p.fourths / p.games*100).toFixed(1) + '%';

        const tr = document.createElement("tr");
        tr.innerHTML =
          `<td><span class="clickable-name" data-id="${p.id}">${p.name}</span></td>` +
          `<td>${p.games}</td>` +
          `<td>${p.totalPoint>=0?'+':''}${p.totalPoint.toFixed(1)}</td>` +
          `<td>${p.tops}<br><small>${topsRate}</small></td>` +
          `<td>${p.seconds}<br><small>${secRate}</small></td>` +
          `<td>${p.thirds}<br><small>${thirdRate}</small></td>` +
          `<td>${p.fourths}<br><small>${fourRate}</small></td>` +
          `<td>${topRate}</td>` +
          `<td>${twoRate}</td>` +
          `<td>${avoidLast}</td>` +
          `<td>${tobiRate}</td>` +
          `<td>${avgRank}</td>` +
          `<td>${avgFinal}</td>`;
        tbody.appendChild(tr);
      });

      applyHighlighting();

      // プレイヤー名クリックで詳細表示
      document.querySelectorAll(".clickable-name").forEach(el => {
        el.addEventListener("click", () => viewPlayerDetail(el.dataset.id));
      });
    }

    // 最大/最小ハイライト
    function applyHighlighting() {
     const table   = document.getElementById("statsTable");
     const rows    = Array.from(table.querySelectorAll("tbody tr"));
     const headers = Array.from(table.querySelectorAll("thead th"))
                       .map(th => th.textContent.trim());
     headers.forEach((header, ci) => {
      // 各セルから比較用の数値を取り出す
      const vals = rows.map(r => {
      const cell = r.cells[ci];
       if (["1位","2位","3位","4位"].includes(header)) {
        // 小要素(<small>)の % 表示をパース
        return parseFloat(cell.querySelector("small").textContent) || 0;
       } else {
        // それ以外はセルのテキストを数値化
        return parseFloat(cell.textContent) || 0;
       }
      });
      const max = Math.max(...vals);
      const min = Math.min(...vals);
      
      rows.forEach((r, i) => {
       const cell = r.cells[ci];
       const v = vals[i];
       cell.classList.remove("highlight-max","highlight-min");
        if (header === "平均着順") {
         // 着順は「小さいほどよい」扱い
         if (v === min) cell.classList.add("highlight-max");
         if (v === max) cell.classList.add("highlight-min");
        } else {
         // その他は「大きいほどよい」
         if (v === max) cell.classList.add("highlight-max");
         if (v === min) cell.classList.add("highlight-min");
        }
      });
     });

    }

    // 詳細表示
    window.viewPlayerDetail = function(pid) {
      const p = window.playerData[pid];
      if (!p) return;
      const div = document.getElementById("playerDetail");
      div.innerHTML = '';

      const avgDiff    = ((p.totalPoint - p.totalRankPoint)/p.games).toFixed(1);
      const avgFinal   = (25000 + parseFloat(avgDiff)*1000).toFixed(0);
      const avgRank    = (p.totalRank/p.games).toFixed(2);
      const topRate    = ((p.tops/p.games)*100).toFixed(1);
      const avoidLast  = (((p.tops+p.seconds+p.thirds)/p.games)*100).toFixed(1);
      const maxPt      = Math.max(...p.pointHistory).toFixed(1);
      const minPt      = Math.min(...p.pointHistory).toFixed(1);
      let maxStreak    = 0, cur = 0;
      p.rankHistory.forEach(r => {
        if (r <= 2) { cur++; maxStreak = Math.max(maxStreak, cur); }
        else { cur = 0; }
      });
      const maxIdx     = p.sessionSums.indexOf(Math.max(...p.sessionSums));
      const minIdx     = p.sessionSums.indexOf(Math.min(...p.sessionSums));
      const maxText    = p.sessionSums.length && maxIdx !== -1 ? `${p.sessionSums[maxIdx].toFixed(1)} pt （${p.sessionHistory[maxIdx].title}）` : '-';
      const minText    = p.sessionSums.length && minIdx !== -1 ? `${p.sessionSums[minIdx].toFixed(1)} pt （${p.sessionHistory[minIdx].title}）` : '-';

      div.innerHTML = `
        <div class="player-detail">
          <h2>${p.name} の成績詳細</h2>
          <p>
            🀄 対局数：${p.games} 回<br>
            🎯 合計ポイント：${p.totalPoint.toFixed(1)} pt<br>
            📈 平均差分：${avgDiff} pt<br>
            🎯 終局時平均点：${avgFinal} pt<br>
            🧮 平均着順：${avgRank} 位<br>
            👑 トップ率：${topRate}%<br>
            🚫 ラス回避率：${avoidLast}%<br>
            🛑 とび回数：${p.tobiCount} 回<br>
            🔄 最高連続連対数：${maxStreak} 回<br>
            🔺 最大差分：${maxPt} pt<br>
            🔻 最小差分：${minPt} pt<br>
            📊 最高1セット：${maxText}<br>
            📉 最低1セット：${minText}
          </p>
          <canvas id="pointChart"></canvas>
          <div class="opponent-section">
            <label>対戦相手を選択：
              <select id="opponentSelect">
                <option value="">--選択--</option>
                ${Object.keys(p.vs).sort().map(opp => `<option value="${opp}">${playersMap[opp] || opp}</option>`).join('')}
              </select>
            </label>
            <div id="opponentStats"></div>
          </div>
        </div>
      `;

      drawPointGraph(p);

      document.getElementById("opponentSelect").addEventListener("change", e => {
        const opp = e.target.value;
        const statsDiv = document.getElementById("opponentStats");
        statsDiv.innerHTML = '';
        if (!opp || !p.vs[opp]) return;
        const vs = p.vs[opp];
        const winRate = (vs.wins / vs.games * 100).toFixed(1);
        const avgDiffOpp = (vs.pointDiff / vs.games).toFixed(1);
        statsDiv.innerHTML = `
          <p>同卓回数：${vs.games} 回</p>
          <p>勝利回数：${vs.wins} 回 (${winRate}%)</p>
          <p>平均点差：${avgDiffOpp} pt</p>
        `;
      });
    };

    // ポイント推移グラフ描画
    function drawPointGraph(p) {
      const cum = [];
      p.pointHistory.reduce((acc, cur) => {
        const next = acc + cur;
        cum.push(next.toFixed(1));
        return next;
      }, 0);
      const labels = cum.map((_, i) => `#${i+1}`);

      const ctx = document.getElementById("pointChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "累積ポイント推移",
            data: cum,
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "対局数" } },
            y: { title: { display: true, text: "累積ポイント" } }
          }
        }
      });
    }
  </script>
</body>
</html>
