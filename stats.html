<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>総合成績 / 個人成績</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --background-color: #f5f5f5;
      --card-background: #ffffff;
      --text-color: #333333;
      --border-radius: 12px;
      --box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      --highlight-blue: #d0e7ff;
      --highlight-red: #ffdede;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    h1, h2 {
      text-align: center;
      color: var(--text-color);
      margin: 1em 0;
    }

    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 15px auto;
      padding: 15px;
      font-size: 1.1em;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .main-button:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--box-shadow);
    }

    .stats-table-container {
      overflow-x: auto;
      margin: 20px 0;
      background: var(--card-background);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 1px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin: 0;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border: 1px solid #eee;
      white-space: nowrap;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--text-color);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:hover {
      background-color: #f8f9fa;
    }

    .clickable-name {
      cursor: pointer;
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .clickable-name:hover {
      text-decoration: underline;
    }

    .player-detail {
      background: var(--card-background);
      border-radius: var(--border-radius);
      padding: 25px;
      margin-top: 30px;
      box-shadow: var(--box-shadow);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .stats-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
    }

    .stats-item p {
      margin: 5px 0;
    }

    .stats-label {
      font-size: 0.9em;
      color: #666;
    }

    .stats-value {
      font-size: 1.2em;
      font-weight: 500;
      color: var(--text-color);
    }

    .graph-container {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    canvas {
      max-width: 100%;
      margin: 20px auto;
    }

    .highlight-max { background-color: var(--highlight-blue); }
    .highlight-min { background-color: var(--highlight-red); }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      th, td {
        padding: 8px;
        font-size: 0.9em;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .player-detail {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>総合成績 / 個人成績</h1>
    <button class="main-button" onclick="location.href='index.html'">ホームへ戻る</button>

    <div class="stats-table-container">
      <table id="statsTable">
        <thead>
          <tr>
            <th>プレイヤー</th>
            <th>対局数</th>
            <th>合計ポイント</th>
            <th>1位回数</th>
            <th>2位回数</th>
            <th>3位回数</th>
            <th>4位回数</th>
            <th>トップ率</th>
            <th>連対率</th>
            <th>ラス回避率</th>
            <th>平均着順</th>
            <th>平均ポイント</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="playerDetail"></div>
  </div>

  <script>
    let playerStats = {};

    function loadSessions() {
      const sessions = JSON.parse(localStorage.getItem('sessions') || '[]');
      sessions.forEach((session, sessionIndex) => {
        session.games.forEach((game, gameIndex) => {
          const sorted = [...game.players].sort((a, b) => b.point - a.point);
          sorted.forEach((p, i) => {
            if (!playerStats[p.name]) {
              playerStats[p.name] = {
                name: p.name, games: 0, tops: 0, seconds: 0, thirds: 0, fourths: 0,
                totalRank: 0, totalPoint: 0, pointHistory: [], rankHistory: [],
                maxScore: { point: -Infinity, date: session.title, sessionNo: sessionIndex + 1, gameNo: gameIndex + 1 },
                minScore: { point: Infinity, date: session.title, sessionNo: sessionIndex + 1, gameNo: gameIndex + 1 }
              };
            }
            const ps = playerStats[p.name];
            ps.games++;
            ps.totalRank += (i + 1);
            ps.totalPoint += p.point;
            ps.pointHistory.push(ps.totalPoint);
            ps.rankHistory.push(i + 1);

            if (p.point > ps.maxScore.point) {
              ps.maxScore = { point: p.point, date: session.title, sessionNo: sessionIndex + 1, gameNo: gameIndex + 1 };
            }
            if (p.point < ps.minScore.point) {
              ps.minScore = { point: p.point, date: session.title, sessionNo: sessionIndex + 1, gameNo: gameIndex + 1 };
            }

            if (i === 0) ps.tops++;
            if (i === 1) ps.seconds++;
            if (i === 2) ps.thirds++;
            if (i === 3) ps.fourths++;
          });
        });
      });
    }

    function createStatsTable() {
      const tbody = document.querySelector('#statsTable tbody');
      tbody.innerHTML = '';
      const players = Object.values(playerStats);

      players.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="clickable-name" onclick="viewPlayerDetail('${p.name}')">${p.name}</span></td>
          <td>${p.games}</td>
          <td>${p.totalPoint >= 0 ? '+' : ''}${p.totalPoint}</td>
          <td>${p.tops}</td>
          <td>${p.seconds}</td>
          <td>${p.thirds}</td>
          <td>${p.fourths}</td>
          <td>${((p.tops / p.games) * 100).toFixed(1)}%</td>
          <td>${(((p.tops + p.seconds) / p.games) * 100).toFixed(1)}%</td>
          <td>${(((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1)}%</td>
          <td>${(p.totalRank / p.games).toFixed(2)}</td>
          <td>${(p.totalPoint / p.games).toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      });

      applyHighlight(players);
    }

    function applyHighlight(players) {
      const rows = document.querySelectorAll('#statsTable tbody tr');
      const fields = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

      fields.forEach(idx => {
        const values = Array.from(rows).map(row => parseFloat(row.children[idx].textContent.replace('+', '').replace('%', '')));
        const max = Math.max(...values);
        const min = Math.min(...values);
        rows.forEach((row, i) => {
          const td = row.children[idx];
          if (values[i] === max) td.classList.add('highlight-max');
          if (values[i] === min) td.classList.add('highlight-min');
        });
      });
    }

    function viewPlayerDetail(name) {
      const p = playerStats[name];
      if (!p) return;

      const detailHtml = `
        <div class="player-detail">
          <h2>${p.name}の成績</h2>
          <div class="stats-grid">
            <div class="stats-item">
              <p class="stats-label">対局数</p>
              <p class="stats-value">${p.games}回</p>
            </div>
            <div class="stats-item">
              <p class="stats-label">合計ポイント</p>
              <p class="stats-value">${p.totalPoint >= 0 ? '+' : ''}${p.totalPoint}点</p>
            </div>
            <div class="stats-item">
              <p class="stats-label">平均ポイント</p>
              <p class="stats-value">${(p.totalPoint / p.games).toFixed(2)}点</p>
            </div>
            <div class="stats-item">
              <p class="stats-label">トップ率</p>
              <p class="stats-value">${((p.tops / p.games) * 100).toFixed(1)}%</p>
            </div>
            <div class="stats-item">
              <p class="stats-label">連対率</p>
              <p class="stats-value">${(((p.tops + p.seconds) / p.games) * 100).toFixed(1)}%</p>
            </div>
            <div class="stats-item">
              <p class="stats-label">ラス回避率</p>
              <p class="stats-value">${(((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1)}%</p>
            </div>
          </div>

          <div class="stats-grid" style="margin-top: 20px;">
            <div class="stats-item">
              <p class="stats-label">最高得点</p>
              <p class="stats-value">＋${p.maxScore.point}点</p>
              <p class="stats-label">(第${p.maxScore.sessionNo}回 ${p.maxScore.gameNo}半荘目)</p>
            </div>
            <div class="stats-item">
              <p class="stats-label">最低得点</p>
              <p class="stats-value">${p.minScore.point}点</p>
              <p class="stats-label">(第${p.minScore.sessionNo}回 ${p.minScore.gameNo}半荘目)</p>
            </div>
          </div>

          <div class="graph-container">
            <button class="main-button" onclick="toggleGraphs('${p.name}')">▶ グラフを見る</button>
            <div id="graphArea" style="display:none;">
              <canvas id="pointChart"></canvas>
              <canvas id="rankChart"></canvas>
            </div>
          </div>
        </div>
      `;
      document.getElementById('playerDetail').innerHTML = detailHtml;
    }

    function toggleGraphs(name) {
      const area = document.getElementById('graphArea');
      if (area.style.display === 'none') {
        area.style.display = 'block';
        drawGraphs(name);
      } else {
        area.style.display = 'none';
      }
    }

    function drawGraphs(name) {
      const p = playerStats[name];
      
      const ctx1 = document.getElementById('pointChart').getContext('2d');
      new Chart(ctx1, {
        type: 'line',
        data: {
          labels: p.pointHistory.map((_, i) => i + 1),
          datasets: [{
            label: '累積ポイント',
            data: p.pointHistory,
            borderColor: 'blue',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: '半荘数' },
              ticks: { stepSize: 5 }
            },
            y: {
              title: { display: true, text: '累積ポイント' }
            }
          }
        }
      });

      const avgRanks = p.rankHistory.map((_, i, arr) => 
        (arr.slice(0, i + 1).reduce((a, b) => a + b, 0) / (i + 1)).toFixed(2)
      );

      const ctx2 = document.getElementById('rankChart').getContext('2d');
      new Chart(ctx2, {
        type: 'line',
        data: {
          labels: avgRanks.map((_, i) => i + 1),
          datasets: [{
            label: '平均着順推移',
            data: avgRanks,
            borderColor: 'green',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: '半荘数' },
              ticks: { stepSize: 5 }
            },
            y: {
              reverse: true,
              min: 1,
              max: 4,
              ticks: { stepSize: 0.5 },
              title: { display: true, text: '平均着順' }
            }
          }
        }
      });
    }

    window.onload = () => {
      loadSessions();
      createStatsTable();
      const firstPlayer = Object.keys(playerStats)[0];
      if (firstPlayer) {
        viewPlayerDetail(firstPlayer);
      }
    };
  </script>
</body>
</html>
