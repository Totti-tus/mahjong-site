<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* çœç•¥ï¼ˆè¦‹ãŸç›®ç”¨ã® CSSï¼‰ */
  </style>
</head>
<body>
  <h1>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</h1>
  <div class="filter-box">
    <label>é–‹å§‹æ—¥ï¼š<input id="startDate" type="date"/></label>
    <label>çµ‚äº†æ—¥ï¼š<input id="endDate" type="date"/></label>
  </div>
  <button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
  <div class="table-wrapper">
    <table id="statsTable">
      <thead>
        <tr>
          <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
          <th>å¯¾å±€æ•°</th>
          <th>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</th>
          <th>1ä½</th>
          <th>2ä½</th>
          <th>3ä½</th>
          <th>4ä½</th>
          <th>ãƒˆãƒƒãƒ—ç‡</th>
          <th>é€£å¯¾ç‡</th>
          <th>ãƒ©ã‚¹å›é¿ç‡</th>
          <th>å¹³å‡ç€é †</th>
          <th>å¹³å‡ç‚¹</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="playerDetail"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import Chart from "https://cdn.jsdelivr.net/npm/chart.js";

    // â”€â”€ (A) Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šæƒ…å ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const firebaseConfig = {
      apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.appspot.com",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // â”€â”€ (B) ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’ä¸€æ‹¬ã§èª­ã¿è¾¼ã‚€ï¼ˆIDâ†’è¡¨ç¤ºåã®ãƒãƒƒãƒ—ã‚’ä½œã‚‹ï¼‰â”€â”€
    const playersMap = {};
    async function loadPlayerNames() {
      const snap = await getDocs(collection(db, "players"));
      snap.forEach(doc => {
        const d = doc.data();
        playersMap[d.id] = d.name;
      });
    }

    // â”€â”€ (C) å…¨ Session ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allSessions = [];

    // â”€â”€ (D) ã€ŒåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ â†’ èªè¨¼å®Œäº†å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€ã¾ã§ã®æµã‚Œ â”€â”€â”€â”€â”€â”€
    signInAnonymously(auth)
      .then(async () => {
        console.log("ğŸ”‘ åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
        // â•â• èªè¨¼å®Œäº†å¾Œã€ä¸€æ°—ã«åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã† â•â•

        // (D-1) ã¾ãšãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€
        await loadPlayerNames();

        // (D-2) æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«å¤‰åŒ–ãŒã‚ã£ãŸã¨ãã‚‚å†æç”»ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        document.getElementById("startDate").addEventListener("change", filterAndCalculate);
        document.getElementById("endDate").addEventListener("change", filterAndCalculate);

        // (D-3) Firestore ã® sessions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–ã—ã¦ã€
        //       ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰éƒ½åº¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦å†æç”»ã™ã‚‹
        const sessionsCol = collection(db, "sessions");
        onSnapshot(sessionsCol, snapshot => {
          allSessions = [];
          snapshot.forEach(doc => allSessions.push(doc.data()));
          filterAndCalculate();
        });
      })
      .catch(err => {
        console.error("âš ï¸ åŒ¿åãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", err.message);
      });

    // â”€â”€ (E) æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ï¼‹å†è¨ˆç®—ãƒ»å†æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function filterAndCalculate() {
      const start = document.getElementById("startDate").value;
      const end   = document.getElementById("endDate").value;
      const filtered = allSessions
        .map(s => ({
          ...s,
          games: s.games.filter(g => (!start || g.date >= start) && (!end || g.date <= end))
        }))
        .filter(s => s.games.length > 0);
      calculateStats(filtered);
    }

    // â”€â”€ (F) çµ±è¨ˆã‚’è¨ˆç®—ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‹è©³ç´°ã‚¨ãƒªã‚¢ã‚’æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function calculateStats(sessions) {
      // â‘  å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é›†è¨ˆç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹
      const playerData = {};
      sessions.forEach(session => {
        session.games.forEach(game => {
          // ç€é †ã§ã‚½ãƒ¼ãƒˆ
          const sorted = [...game.players].sort((a, b) => b.point - a.point);
          sorted.forEach((p, i) => {
            if (!playerData[p.id]) {
              playerData[p.id] = {
                id: p.id,
                name: playersMap[p.id] || p.id,
                games: 0, tops: 0, seconds: 0, thirds: 0, fourths: 0,
                totalRank: 0, totalPoint: 0,
                pointHistory: [], rankHistory: [],
                vs: {}, sessionHistory: [], sessionSums: []
              };
            }
            const d = playerData[p.id];
            d.games++;
            if (i === 0)      d.tops++;
            else if (i === 1) d.seconds++;
            else if (i === 2) d.thirds++;
            else if (i === 3) d.fourths++;

            d.totalRank  += (i + 1);
            d.totalPoint += p.point;
            d.pointHistory.push(p.point);
            d.rankHistory.push(i + 1);

            // â”€â”€ ã€Œ1ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ãŸã‚Šã®åˆè¨ˆç‚¹ã€é…åˆ— â”€â”€
            //  â€»ã“ã“ã§ã¯ä»®ã«ãã®ã¾ã¾ p.point ã‚’è»¢è¨˜ã—ã¦ã„ã¾ã™ãŒã€å¿…è¦ã«å¿œã˜ã¦
            //   ã€Œãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¸­ã®å…¨ã‚²ãƒ¼ãƒ ã‚’åˆè¨ˆã—ãŸå€¤ã€ã‚’æ ¼ç´ã—ã¦ãã ã•ã„ã€‚
            d.sessionSums.push(p.point);
            d.sessionHistory.push({ title: session.title });

            // â”€â”€ ç›¸æ‰‹åˆ¥å‹æ•—ï¼ˆç°¡æ˜“çš„ã«ã€Œç‚¹æ•° >= 0 ã®æ•°ã€ã‚’å‹åˆ©å›æ•°ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼‰â”€â”€
            game.players.forEach(op => {
              if (op.id !== p.id) {
                d.vs[op.id] = (d.vs[op.id] || 0) + (p.point >= 0 ? 1 : 0);
              }
            });
          });
        });
      });

      // â‘¡ ãƒ†ãƒ¼ãƒ–ãƒ«æœ¬ä½“ã‚’ç©ºã«ã—ã¦ã‹ã‚‰å†æ§‹ç¯‰
      const table = document.getElementById("statsTable");
      // <thead>è¡Œä»¥å¤–ã‚’ã™ã¹ã¦å‰Šé™¤
      table.querySelectorAll("tbody, tr:not(:first-child)").forEach(el => el.remove());

      const tbody = document.createElement("tbody");
      Object.values(playerData).forEach(p => {
        const avgPoint      = (p.totalPoint / p.games).toFixed(1);
        const avgRank       = (p.totalRank  / p.games).toFixed(2);
        const topRate       = ((p.tops / p.games) * 100).toFixed(1) + "%";
        const avoidLastRate = (((p.games - p.fourths) / p.games) * 100).toFixed(1) + "%";
        const maxPoint      = Math.max(...p.pointHistory).toFixed(1);
        const minPoint      = Math.min(...p.pointHistory).toFixed(1);
        const maxIdx        = p.sessionSums.indexOf(Math.max(...p.sessionSums));
        const minIdx        = p.sessionSums.indexOf(Math.min(...p.sessionSums));
        const maxSession    = maxIdx !== -1
          ? `${p.sessionSums[maxIdx].toFixed(1)} pt (${p.sessionHistory[maxIdx].title})`
          : "-";
        const minSession    = minIdx !== -1
          ? `${p.sessionSums[minIdx].toFixed(1)} pt (${p.sessionHistory[minIdx].title})`
          : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.games}</td>
          <td>${p.totalPoint.toFixed(1)}</td>
          <td>${p.tops}</td>
          <td>${p.seconds}</td>
          <td>${p.thirds}</td>
          <td>${p.fourths}</td>
          <td>${topRate}</td>
          <td>${((p.tops + p.seconds) / p.games * 100).toFixed(1)}%</td>
          <td>${avoidLastRate}</td>
          <td>${avgRank}</td>
          <td>${avgPoint}</td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      // â‘¢ å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è©³ç´°ã‚¨ãƒªã‚¢ï¼ˆã‚°ãƒ©ãƒ•ï¼‹ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼‰ã‚’è¡¨ç¤º
      const detailDiv = document.getElementById("playerDetail");
      detailDiv.innerHTML = ""; // ã¾ãšã‚¯ãƒªã‚¢

      Object.values(playerData).forEach(p => {
        const container = document.createElement("div");
        container.className = "player-detail";
        container.innerHTML = `
          <h2>${p.name} ã®æˆç¸¾è©³ç´°</h2>
          <p>
            ğŸ€„ å¯¾å±€æ•°ï¼š${p.games} å›<br>
            ğŸ¯ åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼š${p.totalPoint.toFixed(1)} pt<br>
            ğŸ“ˆ å¹³å‡ãƒã‚¤ãƒ³ãƒˆï¼š${((p.totalPoint / p.games)||0).toFixed(1)} pt<br>
            ğŸ§® å¹³å‡ç€é †ï¼š${((p.totalRank / p.games)||0).toFixed(2)} ä½<br>
            ğŸ‘‘ ãƒˆãƒƒãƒ—ç‡ï¼š${((p.tops / p.games)*100).toFixed(1)}%<br>
            ğŸš« ãƒ©ã‚¹å›é¿ç‡ï¼š${(((p.games - p.fourths) / p.games)*100).toFixed(1)}%<br>
            ğŸ”º 1åŠè˜ã§ã®æœ€å¤§ç²å¾—ptï¼š${maxPoint} pt<br>
            ğŸ”» 1åŠè˜ã§ã®æœ€å°ç²å¾—ptï¼š${minPoint} pt<br>
            ğŸ“Š 1æ—¥(1ã‚»ãƒƒãƒˆ)ã§ã®æœ€é«˜æˆç¸¾ï¼š${maxSession}<br>
            ğŸ“‰ 1æ—¥(1ã‚»ãƒƒãƒˆ)ã§ã®æœ€ä½æˆç¸¾ï¼š${minSession}<br>
          </p>
          <canvas id="pointChart-${p.id}" height="150"></canvas>
          <div class="opponent-section">
            <label>å¯¾æˆ¦ç›¸æ‰‹ã‚’é¸æŠï¼š
              <select id="opponentSelect-${p.id}">
                <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
              </select>
            </label>
            <div id="opponentStats-${p.id}"></div>
          </div>
        `;
        detailDiv.appendChild(container);

        // â”€â”€ ç´¯ç©ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ• â”€â”€
        const ctx = document.getElementById(`pointChart-${p.id}`).getContext("2d");
        const cumulative = p.pointHistory.reduce((acc, cur, idx) => {
          acc.push((idx === 0 ? 0 : acc[idx-1]) + cur);
          return acc;
        }, []);
        new Chart(ctx, {
          type: "line",
          data: {
            labels: cumulative.map((_, i) => i + 1),
            datasets: [{
              label: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ",
              data: cumulative,
              borderColor: "blue",
              fill: false
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: { title: { display: true, text: "å¯¾å±€æ•°" } },
              y: { title: { display: true, text: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ" } }
            }
          }
        });

        // â”€â”€ å¯¾æˆ¦ç›¸æ‰‹åˆ¥å‹åˆ©å›æ•°ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ â”€â”€
        const sel = document.getElementById(`opponentSelect-${p.id}`);
        Object.keys(p.vs).sort().forEach(oppId => {
          const opt = document.createElement("option");
          opt.value = oppId;
          // å‹åˆ©å›æ•°ã‚’è¡¨ç¤ºä¾‹ã¨ã—ã¦å…¥ã‚Œã¦ãŠã
          opt.textContent = `${playersMap[oppId] || oppId} (å‹åˆ©ï¼š${p.vs[oppId]}å›)`;
          sel.appendChild(opt);
        });

        sel.addEventListener("change", e => {
          const oppId = e.target.value;
          const winCount = p.vs[oppId] || 0;
          const totalGames = sessions
            .flatMap(s => s.games)
            .filter(g => g.players.some(x => x.id === p.id) && g.players.some(x => x.id === oppId))
            .length;
          const winRate = totalGames > 0 ? ((winCount / totalGames) * 100).toFixed(1) : "-";
          const statsDiv = document.getElementById(`opponentStats-${p.id}`);
          statsDiv.innerHTML = `
            <p>
              ğŸ“Š ${p.name} vs ${playersMap[oppId] || oppId}<br>
              ğŸ” åŒå“å›æ•°ï¼š${totalGames} å›<br>
              ğŸ¥‡ å‹åˆ©å›æ•°ï¼š${winCount} å› (${winRate}%)<br>
            </p>
          `;
        });
      });
    }
  </script>
</body>
</html>
