<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .filter-box {
      max-width: 500px;
      margin: 10px auto;
      text-align: center;
    }
    .filter-box input {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #e0e0e0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 2;
      font-weight: bold;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .highlight-max { background-color: #d0e7ff; }
    .highlight-min { background-color: #ffdede; }
    .clickable-name {
      cursor: pointer;
      color: #007bff;
      text-decoration: underline;
    }
    .player-detail {
      background-color: #e6f4ea;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    canvas {
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h1>ç·åˆæˆç¸¾ / å€‹äººæˆç¸¾</h1>

  <div class="filter-box">
    <label>é–‹å§‹æ—¥ï¼š<input id="startDate" type="date" /></label>
    <label>çµ‚äº†æ—¥ï¼š<input id="endDate" type="date" /></label>
  </div>
  <button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>

  <div class="table-wrapper">
    <table id="statsTable">
      <thead>
        <tr>
          <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
          <th>å¯¾å±€æ•°</th>
          <th>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</th>
          <th>1ä½</th>
          <th>2ä½</th>
          <th>3ä½</th>
          <th>4ä½</th>
          <th>ãƒˆãƒƒãƒ—ç‡</th>
          <th>é€£å¯¾ç‡</th>
          <th>ãƒ©ã‚¹å›é¿ç‡</th>
          <th>å¹³å‡ç€é †</th>
          <th>å¹³å‡çµ‚å±€å¾—ç‚¹</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="playerDetail"></div>

  <script type="module">
    // Firebase SDK èª­ã¿è¾¼ã¿ï¼ˆèªè¨¼ï¼‹Firestoreï¼‰
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { collection as colSessions } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase åˆæœŸè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.appspot.com",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31",
      measurementId: "G-NP9EELBD7R"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // åŒ¿åèªè¨¼
    const auth = getAuth();
    signInAnonymously(auth)
      .catch(error => console.error("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", error.message));
    onAuthStateChanged(auth, user => {
      console.log(user ? "ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼: " + user.uid : "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“");
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let allSessions = [];      // Firestore ã‹ã‚‰å–å¾—ã—ãŸã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³
    const playersMap = {};     // { playerId: playerName, ... }
    window.playerData = {};    // è¨ˆç®—æ¸ˆãƒ‡ãƒ¼ã‚¿

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—
    async function loadPlayerNames() {
      const snap = await getDocs(collection(db, "players"));
      snap.forEach(docSnap => {
        const data = docSnap.data();
        playersMap[data.id] = data.name;
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadPlayerNames();

      // sessions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–
      onSnapshot(colSessions(db, "sessions"), snapshot => {
        allSessions = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          allSessions.push({ title: data.title, games: data.games });
        });
        filterAndCalculate();
      });

      // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´æ™‚
      document.getElementById("startDate").addEventListener("change", filterAndCalculate);
      document.getElementById("endDate").addEventListener("change", filterAndCalculate);
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ â†’ é›†è¨ˆ â†’ æç”»
    function filterAndCalculate() {
      const start = document.getElementById("startDate").value;
      const end   = document.getElementById("endDate").value;
      const filtered = allSessions.map(sess => ({
        ...sess,
        games: sess.games.filter(g => {
          const d = g.date;
          return (!start || d >= start) && (!end || d <= end);
        })
      })).filter(sess => sess.games.length > 0);

      // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
      filtered.sort((a, b) => new Date(a.title) - new Date(b.title));

      calculateStats(filtered);
      renderTable();
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã«é›†è¨ˆï¼ˆçµ‚å±€å¾—ç‚¹ã‚‚é€†ç®—ï¼‰
    function calculateStats(sessions) {
      const rankPointMap = {1:50,2:10,3:-10,4:-50};
      const BASE = 30000;
      const pd = {}; // ä¸€æ™‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

      sessions.forEach(session => {
        session.games.forEach(game => {
          // game.players = [ { id, point }, ... ]
          const sorted = [...game.players].sort((a, b) => b.point - a.point);
          sorted.forEach((p, idx) => {
            if (!pd[p.id]) {
              pd[p.id] = {
                id: p.id,
                name: playersMap[p.id] || p.id,
                games: 0,
                tops: 0,
                seconds: 0,
                thirds: 0,
                fourths: 0,
                totalRank: 0,
                totalPoint: 0,
                totalFinalScore: 0,
                finalScoreHistory: [],
                pointHistory: [],
                rankHistory: [],
                vs: {},            // å¯¾æˆ¦ç›¸æ‰‹ã”ã¨ã®é›†è¨ˆ
                sessionHistory: [], // å‚åŠ ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³
                sessionSums: []     // ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã®åˆè¨ˆpt
              };
            }
            const d = pd[p.id];

            // çµ‚å±€æ™‚å¾—ç‚¹ã‚’é€†ç®—
            const rank = idx + 1;
            const rankPt = rankPointMap[rank];
            const rawDiff = p.point - rankPt;
            const finalScore = BASE + rawDiff;
            d.totalFinalScore += finalScore;
            d.finalScoreHistory.push(finalScore);

            // å„ç¨®é›†è¨ˆ
            d.games++;
            d.totalPoint += p.point;
            d.totalRank += rank;
            d.pointHistory.push(p.point);
            d.rankHistory.push(rank);
            if (rank === 1)      d.tops++;
            else if (rank === 2) d.seconds++;
            else if (rank === 3) d.thirds++;
            else if (rank === 4) d.fourths++;

            // VSé›†è¨ˆ
            game.players.forEach(op => {
              if (op.id === p.id) return;
              if (!d.vs[op.id]) d.vs[op.id] = { games: 0, wins: 0, pointDiff: 0 };
              d.vs[op.id].games++;
              d.vs[op.id].pointDiff += (p.point - op.point);
              if (p.point > op.point) d.vs[op.id].wins++;
            });
          });

          // ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´
          Object.keys(pd).forEach(pid => {
            const participated = session.games.some(gm => gm.players.some(x => x.id === pid));
            if (participated) pd[pid].sessionHistory.push(session);
          });
        });
      });

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã®åˆè¨ˆptã‚’ç®—å‡º
      Object.values(pd).forEach(p => {
        p.sessionSums = p.sessionHistory.map(sess =>
          sess.games.reduce((acc, gm) => {
            const me = gm.players.find(x => x.id === p.id);
            return acc + (me ? me.point : 0);
          }, 0)
        );
      });

      window.playerData = pd;
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = "";
      Object.values(window.playerData).forEach(p => {
        const avgFinal = (p.totalFinalScore / p.games).toFixed(0);
        const avgRank  = (p.totalRank / p.games).toFixed(2);
        const topRate  = ((p.tops / p.games) * 100).toFixed(1) + "%";
        const twoRate  = (((p.tops + p.seconds) / p.games) * 100).toFixed(1) + "%";
        const avoidLast= (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1) + "%";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="clickable-name" data-id="${p.id}">${p.name}</span></td>
          <td>${p.games}</td>
          <td>${p.totalPoint >= 0 ? "+" : ""}${p.totalPoint.toFixed(1)}</td>
          <td>${p.tops}</td>
          <td>${p.seconds}</td>
          <td>${p.thirds}</td>
          <td>${p.fourths}</td>
          <td>${topRate}</td>
          <td>${twoRate}</td>
          <td>${avoidLast}</td>
          <td>${avgRank}</td>
          <td>${avgFinal}</td>
        `;
        tbody.appendChild(tr);
      });
      applyHighlighting();

      // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
      document.querySelectorAll(".clickable-name").forEach(el =>
        el.addEventListener("click", () => viewPlayerDetail(el.dataset.id))
      );

      // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¡¨ç¤º
      const firstId = Object.keys(window.playerData)[0];
      if (firstId) viewPlayerDetail(firstId);
    }

    // æœ€å¤§ï¼æœ€å°ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    function applyHighlighting() {
      const table = document.getElementById("statsTable");
      const rows  = Array.from(table.querySelectorAll("tbody tr"));
      const nCols = table.rows[0].cells.length;
      for (let c = 1; c < nCols; c++) {
        let max = -Infinity, min = Infinity;
        rows.forEach(row => {
          const v = parseFloat(row.cells[c].textContent);
          if (!isNaN(v)) {
            max = Math.max(max, v);
            min = Math.min(min, v);
          }
        });
        rows.forEach(row => {
          const cell = row.cells[c];
          const v = parseFloat(cell.textContent);
          cell.classList.remove("highlight-max", "highlight-min");
          const header = table.rows[0].cells[c].textContent.trim();
          if (!isNaN(v)) {
            if (header === "å¹³å‡ç€é †") {
              if (v === min) cell.classList.add("highlight-max");
              if (v === max) cell.classList.add("highlight-min");
            } else {
              if (v === max) cell.classList.add("highlight-max");
              if (v === min) cell.classList.add("highlight-min");
            }
          }
        });
      }
    }

    // è©³ç´°è¡¨ç¤ºï¼ˆãƒãƒ£ãƒ¼ãƒˆå«ã‚€ï¼‰
    window.viewPlayerDetail = function(pid) {
      const p = window.playerData[pid];
      if (!p) return;
      const detailDiv = document.getElementById("playerDetail");
      detailDiv.innerHTML = "";

      // åŸºæœ¬æƒ…å ±
      const avgPoint    = (p.totalPoint / p.games).toFixed(1);
      const avgRank     = (p.totalRank / p.games).toFixed(2);
      const topRateVal  = ((p.tops / p.games) * 100).toFixed(1);
      const avoidLastVal= (((p.tops + p.seconds + p.thirds) / p.games) * 100).toFixed(1);
      const maxPoint    = Math.max(...p.pointHistory).toFixed(1);
      const minPoint    = Math.min(...p.pointHistory).toFixed(1);
      const maxIdx      = p.sessionSums.indexOf(Math.max(...p.sessionSums));
      const minIdx      = p.sessionSums.indexOf(Math.min(...p.sessionSums));
      const maxSession  = p.sessionSums.length && maxIdx !== -1
                          ? `${p.sessionSums[maxIdx].toFixed(1)} pt (${p.sessionHistory[maxIdx].title})`
                          : "-";
      const minSession  = p.sessionSums.length && minIdx !== -1
                          ? `${p.sessionSums[minIdx].toFixed(1)} pt (${p.sessionHistory[minIdx].title})`
                          : "-";

      detailDiv.innerHTML = `
        <div class="player-detail">
          <h2>${p.name} ã®æˆç¸¾è©³ç´°</h2>
          <p>
            ğŸ€„ å¯¾å±€æ•°ï¼š${p.games} å›<br>
            ğŸ¯ åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼š${p.totalPoint.toFixed(1)} pt<br>
            ğŸ“ˆ å¹³å‡ãƒã‚¤ãƒ³ãƒˆï¼š${avgPoint} pt<br>
            ğŸ§® å¹³å‡ç€é †ï¼š${avgRank} ä½<br>
            ğŸ‘‘ ãƒˆãƒƒãƒ—ç‡ï¼š${topRateVal}%<br>
            ğŸš« ãƒ©ã‚¹å›é¿ç‡ï¼š${avoidLastVal}%<br>
            ğŸ”º 1åŠè˜ã§ã®æœ€å¤§ç²å¾—ptï¼š${maxPoint} pt<br>
            ğŸ”» 1åŠè˜ã§ã®æœ€å°ç²å¾—ptï¼š${minPoint} pt<br>
            ğŸ“Š 1æ—¥(1ã‚»ãƒƒãƒˆ)ã§ã®æœ€é«˜æˆç¸¾ï¼š${maxSession}<br>
            ğŸ“‰ 1æ—¥(1ã‚»ãƒƒãƒˆ)ã§ã®æœ€ä½æˆç¸¾ï¼š${minSession}<br>
          </p>
          <canvas id="pointChart"></canvas>
          <div class="opponent-section">
            <label>å¯¾æˆ¦ç›¸æ‰‹ã‚’é¸æŠï¼š
              <select id="opponentSelect">
                <option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>
                ${Object.keys(p.vs).sort().map(oppId =>
                  `<option value="${oppId}">${playersMap[oppId] || oppId}</option>`
                ).join('')}
              </select>
            </label>
            <div id="opponentStats"></div>
          </div>
        </div>
      `;

      // ç´¯ç©ãƒã‚¤ãƒ³ãƒˆã‚°ãƒ©ãƒ•æç”»
      drawPointGraph(p);

      document.getElementById("opponentSelect").addEventListener("change", e => {
        const oppId = e.target.value;
        if (oppId) drawOpponentGraph(p.vs[oppId], oppId);
      });
    };

    // ç´¯ç©ãƒã‚¤ãƒ³ãƒˆæ¨ç§»
    function drawPointGraph(p) {
      const cum = [];
      p.pointHistory.reduce((acc, cur) => {
        const next = acc + cur;
        cum.push(next.toFixed(1));
        return next;
      }, 0);
      const labels = cum.map((_, i) => `#${i + 1}`);

      const ctx = document.getElementById("pointChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆæ¨ç§»",
            data: cum,
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: "å¯¾å±€æ•°" } },
            y: { title: { display: true, text: "ç´¯ç©ãƒã‚¤ãƒ³ãƒˆ" } }
          }
        }
      });
    }

    // ï¼ˆçœç•¥ï¼‰å¯¾æˆ¦ç›¸æ‰‹ã‚°ãƒ©ãƒ•æç”»ãªã©ã®é–¢æ•°...
// å¯¾æˆ¦ç›¸æ‰‹ã‚°ãƒ©ãƒ•æç”»
function drawOpponentGraph(vsData, oppId) {
  // å¯¾æˆ¦å›ã”ã¨ã®å¾—å¤±ç‚¹å·®ã‚’ç´¯ç©ã—ã¦æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã«
  const diffs = vsData.pointDiffHistory || [];  // ã‚ã‚‰ã‹ã˜ã‚ pointDiffHistory ã‚’å…¥ã‚Œã¦ãŠã
  const cum  = [];
  diffs.reduce((acc, cur) => {
    const next = acc + cur;
    cum.push(next.toFixed(1));
    return next;
  }, 0);
  const labels = cum.map((_, i) => `å¯¾æˆ¦${i+1}`);

  // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
  if (window.oppChart) window.oppChart.destroy();

  const ctx = document.getElementById("pointChartOpponent")?.getContext("2d");
  if (!ctx) {
    // canvas è¦ç´ ãŒãªã‘ã‚Œã°å‹•çš„ã«æŒ¿å…¥
    const div = document.getElementById("opponentStats");
    div.innerHTML = `<canvas id="pointChartOpponent"></canvas>`;
  }
  const c = document.getElementById("pointChartOpponent").getContext("2d");

  window.oppChart = new Chart(c, {
    type: "line",
    data: { labels, datasets: [{ label: `${playersMap[oppId]} ã¨ã®ç´¯ç©å¾—å¤±ç‚¹`, data: cum, fill: false, tension: 0.1 }] },
    options: { responsive: true, scales: { x:{ title:{display:true,text:"å¯¾æˆ¦å›"}}, y:{ title:{display:true,text:"ç´¯ç©å¾—å¤±ç‚¹"} } } }
  });
}

// å¯¾æˆ¦ç›¸æ‰‹åˆ¥çµ±è¨ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderOpponentStats(vsData) {
  const div = document.getElementById("opponentStats");
  const totalGames = vsData.games;
  const winRate    = ((vsData.wins / totalGames) * 100).toFixed(1) + "%";
  const avgDiff    = (vsData.pointDiff / totalGames).toFixed(1);
  div.insertAdjacentHTML("afterbegin", `
    <p>
      å¯¾æˆ¦å›æ•°ï¼š${totalGames}å›<br>
      å‹ç‡ï¼š${winRate}<br>
      å¹³å‡å¾—å¤±ç‚¹ï¼š${avgDiff}pt
    </p>
  `);
}

  </script>
</body>
</html>
