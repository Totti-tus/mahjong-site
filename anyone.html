<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>臨時成績登録（保存なし・セッション蓄積・3/4人対応）</title>
  <style>
    :root{
      --bg1:#0f1222; --bg2:#1b1f36; --card:#121528cc; --border:#2a2f4a; --muted:#9aa3b2; --text:#f2f5ff;
      --gap:14px; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
      --accent:#66e1ff; --good:#20e3aa; --warn:#ffbe5e; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;line-height:1.65;margin:0;color:var(--text);
      background:radial-gradient(1200px 700px at 10% -10%,#1c2141 0%,transparent 60%),
                 radial-gradient(900px 600px at 90% 10%,#0e2230 0%,transparent 55%),
                 linear-gradient(160deg,var(--bg1),var(--bg2));}
    header{position:sticky;top:0;background:#0b0e1acc;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);padding:12px 18px;z-index:10}
    header h1{font-size:18px;margin:0}
    header .sub{color:var(--muted);font-size:12px}
    main{max-width:1180px;margin:24px auto;padding:0 16px 72px}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width:1000px){.grid{grid-template-columns:380px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);border-radius:var(--radius) var(--radius) 0 0}
    .card .content{padding:14px}
    fieldset{border:1px solid var(--border);border-radius:12px;margin:0 0 12px}
    legend{padding:0 6px;color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button{font:inherit;color:var(--text)}
    input[type="number"],input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.04)}
    input::placeholder{color:#7a88a8}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row>div{flex:1 1 160px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#2dd6ff33,#2dd6ff11);border-color:#2dd6ff55;color:#ccf8ff}
    .btn.ghost{background:transparent}
    .pill{display:inline-flex;align-items:center;gap:8px}
    .badge{display:inline-block;background:#0d2533;border:1px solid #134357;color:#9eeeff;padding:4px 10px;border-radius:999px;font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{background:linear-gradient(180deg,rgba(255,255,255,.05),transparent);position:sticky;top:64px}
    tfoot td{font-weight:600;background:linear-gradient(180deg,transparent,rgba(255,255,255,.03))}
    .muted{color:var(--muted);font-size:12px}
    .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .sticky-tools{position:sticky;top:64px;padding:8px;background:#0b0e1acc;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);z-index:5;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <h1>臨時成績登録 <span class="badge">保存なし・3/4人対応</span></h1>
    <div class="sub">オカ/ウマ/チップを可変で試算。セッションとして蓄積し、当日トータルを表示（設定・一覧はこの端末に保存）。</div>
  </header>
  <main class="grid">

    <!-- 設定パネル -->
    <section class="card" id="settingsCard">
      <h2>ルール設定</h2>
      <div class="content">
        <fieldset>
          <legend>基本</legend>
          <div class="row">
            <div>
              <label>人数</label>
              <select id="playerCount">
                <option value="4">4人打ち</option>
                <option value="3">3人打ち</option>
              </select>
            </div>
            <div>
              <label>配給原点（開始持ち点）</label>
              <input type="number" id="startPoints" value="25000" step="100" />
            </div>
            <div>
              <label>原点（返しの基準点）</label>
              <input type="number" id="targetPoints" value="30000" step="100" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>オカ（トップ賞）<span class="muted">pt</span></label>
              <input type="number" id="oka" value="20000" step="1000" />
            </div>
            <div>
              <label>ウマ（人数分・カンマ区切り）</label>
              <input type="text" id="uma" placeholder="30,10,-10,-30 / 20,0,-20" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>端数処理</label>
              <select id="rounding">
                <option value="none">処理なし</option>
                <option value="fiveSix" selected>100の位を五捨六入</option>
              </select>
            </div>
            <div>
              <label>レート <span class="muted">円/pt</span></label>
              <input type="number" id="rateYen" value="0" step="1" />
            </div>
            <div>
              <label>チップ単価 <span class="muted">pt/枚</span></label>
              <input type="number" id="chipUnit" value="1" step="1" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>同点時の処理</label>
              <select id="tiePolicy">
                <option value="avg" selected>順位点を同順位の平均で配分（着順入力不要）</option>
                <option value="input">入力した着順を使用（着順必須・同点でもそのまま）</option>
              </select>
            </div>
          </div>
        </fieldset>
        <div class="actions">
          <button class="btn" id="resetBtn">入力クリア</button>
          <button class="btn primary" id="calcBtn">計算する</button>
          <button class="btn" id="commitBtn">確定して一覧に追加</button>
          <button class="btn ghost" id="clearSessionsBtn">一覧を全てクリア</button>
        </div>
        <div id="hint" class="muted" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- 入力＆結果 -->
    <section class="card" id="entryCard">
      <h2>プレイヤー入力</h2>
      <div class="content">
        <div class="row">
          <div><label>対局名（任意）</label><input type="text" id="title" placeholder="2025-08-16 午後卓 1半荘"/></div>
          <div><label>メモ（任意）</label><input type="text" id="memo" placeholder="東南・赤3 など"/></div>
        </div>

        <div id="players"></div>
        <div class="actions">
          <button class="btn" id="rankByScoreBtn">スコアから着順を自動入力</button>
        </div>

        <div class="hr"></div>
        <fieldset>
          <legend>チップ枚数（任意）</legend>
          <div id="chips"></div>
          <div id="chipWarn" class="muted" style="margin-top:6px"></div>
        </fieldset>

        <div class="sticky-tools row">
          <div class="pill"><span class="muted">コピー:</span>
            <button class="btn" id="copyCsvBtn">CSV</button>
            <button class="btn" id="copyTsvBtn">TSV</button>
            <button class="btn" id="copyTextBtn">テキスト</button>
            <button class="btn" id="printBtn">印刷</button>
          </div>
          <div class="pill"><span class="muted">エクスポート:</span>
            <button class="btn" id="exportJsonBtn">JSON</button>
          </div>
        </div>

        <div id="warn" class="muted" style="margin-top:8px"></div>
        <div id="resultWrap"></div>
      </div>
    </section>

    <!-- セッション一覧 -->
    <section class="card" id="listCard">
      <h2>当日のセッション一覧</h2>
      <div class="content">
        <div id="sessionsWrap" class="muted">まだ追加されていません。</div>
      </div>
    </section>

  </main>

  <template id="playerRowTpl">
    <fieldset style="margin:10px 0">
      <legend>プレイヤー <span class="p-index"></span></legend>
      <div class="row">
        <div>
          <label>名前</label>
          <input type="text" class="p-name" placeholder="プレイヤー名" />
        </div>
        <div>
          <label>素点（終局時点棒）</label>
          <input type="number" class="p-score" step="100" value="25000" />
        </div>
        <div>
          <label>着順</label>
          <select class="p-rank"></select>
        </div>
      </div>
    </fieldset>
  </template>

  <template id="chipRowTpl">
    <div class="row"><div>
      <label>名前</label>
      <input type="text" class="c-name" placeholder="プレイヤー名" />
    </div>
    <div>
      <label>チップ枚数</label>
      <input type="number" class="c-chips" step="1" value="0" />
    </div></div>
  </template>

  <script>
    const $ = (s, r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const LS = {
      save(key, obj){ try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){} },
      load(key, def){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v): def; }catch(e){ return def; } }
    };
    const LS_KEYS = { settings:"tempEntryPro.settings", sessions:"tempEntryPro.sessions", players:"tempEntryPro.players", chips:"tempEntryPro.chips" };

    function buildRankOptions(sel, n){ sel.innerHTML=''; for(let i=1;i<=n;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); sel.appendChild(o);} }
    function hundredFiveSix(x){ const r=((x%100)+100)%100; if(r<=50) return x - r; return x + (100 - r); }

    function parseUma(str, n){ const arr = String(str||'').split(/[,、\s]+/).map(s=>s.trim()).filter(Boolean).map(Number); if(arr.length!==n || arr.some(Number.isNaN)) throw new Error(`ウマは人数(${n})に合わせて ${n} 個の数値を入力してください`); return arr; }

    function initPlayers(n){ const wrap=$('#players'); wrap.innerHTML=''; for(let i=0;i<n;i++){ const t=document.importNode($('#playerRowTpl').content,true); t.querySelector('.p-index').textContent=String(i+1); buildRankOptions(t.querySelector('.p-rank'), n); wrap.appendChild(t);} const start = Number($('#startPoints').value||25000); $$('.p-score').forEach(el=>el.value=start);}
    function initChips(n){ const wrap=$('#chips'); wrap.innerHTML=''; for(let i=0;i<n;i++){ const t=document.importNode($('#chipRowTpl').content,true); wrap.appendChild(t);} }

    function getSettings(){ return {
      n: Number($('#playerCount').value||4), startPoints:Number($('#startPoints').value||25000), targetPoints:Number($('#targetPoints').value||30000),
      oka:Number($('#oka').value||0), umaStr:$('#uma').value, rounding:$('#rounding').value, rate:Number($('#rateYen').value||0), chipUnit:Number($('#chipUnit').value||0), tie:$('#tiePolicy').value,
      title:$('#title').value.trim(), memo:$('#memo').value.trim()
    }; }

    function setSettings(s){ if(!s) return; $('#playerCount').value=String(s.n||4); $('#startPoints').value=s.startPoints??25000; $('#targetPoints').value=s.targetPoints??30000; $('#oka').value=s.oka??20000; $('#uma').value=s.umaStr??''; $('#rounding').value=s.rounding||'fiveSix'; $('#rateYen').value=s.rate??0; $('#chipUnit').value=s.chipUnit??1; $('#tiePolicy').value=s.tie||'avg'; $('#title').value=s.title||''; $('#memo').value=s.memo||''; }

    function collectPlayers(){ const ps=$$('#players fieldset').map((fs,i)=>({ name:$('.p-name',fs).value.trim()||`P${i+1}`, score:Number($('.p-score',fs).value||0), rank:Number($('.p-rank',fs).value||0) })); return ps; }
    function collectChips(){ const cs=$$('#chips .row').map((row,i)=>({ name:$('.c-name',row).value.trim()||`P${i+1}`, chips:Number($('.c-chips',row).value||0) })); return cs; }

    function applyTiePolicyRanks(players, tiePolicy){
      if(tiePolicy==='input') return players.map(p=>({ ...p }));
      // score-desc ranking with ties -> rank numbers but we'll use rankStart for UMA averaging
      const sorted = players.slice().sort((a,b)=> b.score - a.score);
      const result = new Array(players.length);
      // map name->index
      const indexByName = new Map(players.map((p,i)=>[p.name,i]));
      let i=0; let place=1;
      while(i<sorted.length){
        // find tie group
        const s = sorted[i].score; let j=i; while(j<sorted.length && sorted[j].score===s) j++;
        for(let k=i;k<j;k++){ const origIndex = indexByName.get(sorted[k].name); result[origIndex] = { ...players[origIndex], rank: place, tieSize: j-i, tieStart: place }; }
        place += (j-i); i=j;
      }
      return result;
    }

    function compute(){
      const warn=$('#warn'); warn.textContent=''; warn.className='muted';
      const chipWarn=$('#chipWarn'); chipWarn.textContent='';
      const s = getSettings();
      const n=s.n; const uma=parseUma(s.umaStr||defaultUma(n), n);
      let players = collectPlayers();
      // tie policy
      players = applyTiePolicyRanks(players, s.tie);

      // chip list (optional)
      const chipEntries = collectChips();
      // match chips by name
      const chipsByName = new Map(chipEntries.map(c=>[c.name,c.chips]));

      // rounding
      function adj(x){ if(s.rounding==='none') return x; return hundredFiveSix(x); }

      // compute per player
      // Oka handling: top-only. If tie at top and tiePolicy==='avg', Okaはトップ同点者で等分
      const topTieCount = Math.max(...players.filter(p=>p.rank===1).map(p=>p.tieSize||1), 1);
      const okaEach = (players.some(p=>p.rank===1) ? (s.oka/100)/(topTieCount) : 0); // convert pt: oka is in pt already? In our UI it's pt. Here we divide by 100? Wait.
    }
  </script>
  <script>(function(){
    function boot(){
      var pc=document.getElementById('playerCount');
      var n=Number((pc&&pc.value)||4);
      if(typeof initPlayers==='function') initPlayers(n);
      if(typeof initChips==='function') initChips(n);
      if(pc){ pc.addEventListener('change', function(e){
        var cnt=Number(e.target.value||4);
        if(typeof initPlayers==='function') initPlayers(cnt);
        if(typeof initChips==='function') initChips(cnt);
      }); }
    }
    if(document.readyState!=='loading') boot(); else document.addEventListener('DOMContentLoaded', boot);
  })();</script>
</body>
</html>
