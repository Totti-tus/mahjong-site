<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>臨時成績登録（保存なし・3/4人対応・フル版）</title>
  <style>
    /* ==== Theme: clean & cool (dark glass) ==== */
    :root{
      --bg1:#0f1222; /* deep navy */
      --bg2:#1b1f36; /* indigo */
      --card:#121528cc; /* glassy */
      --border:#2a2f4a;
      --muted:#9aa3b2;
      --text:#f2f5ff;
      --accent:#66e1ff; /* cyan */
      --accent-weak:#2bd4c4; /* teal */
      --gap:14px;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;
      line-height:1.65;margin:0;color:var(--text);
      background:radial-gradient(1200px 700px at 10% -10%,#1c2141 0%,transparent 60%),
                 radial-gradient(900px 600px at 90% 10%,#0e2230 0%,transparent 55%),
                 linear-gradient(160deg,var(--bg1),var(--bg2));
    }
    header{position:sticky;top:0;background:#0b0e1acc;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);padding:12px 18px;z-index:10}
    header h1{font-size:18px;margin:0;letter-spacing:.02em}
    header .sub{color:var(--muted);font-size:12px}
    main{max-width:1160px;margin:24px auto;padding:0 16px 56px}
    .grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media(min-width:980px){.grid{grid-template-columns:380px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card h2{font-size:15px;margin:0;padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.03),transparent);border-radius:var(--radius) var(--radius) 0 0}
    .card .content{padding:14px}
    fieldset{border:1px solid var(--border);border-radius:12px}
    legend{padding:0 6px;color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button{font:inherit;color:var(--text)}
    input[type="number"],input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.03)}
    input::placeholder{color:#60708f}
    select{background:rgba(255,255,255,.04)}
    input[type="checkbox"]{transform:scale(1.1)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row>div{flex:1 1 160px}
    .muted{color:var(--muted);font-size:12px}
    .help{font-size:11px;color:#7e8aa4}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#2dd6ff33,#2dd6ff11);border-color:#2dd6ff55;color:#ccf8ff}
    .btn.ghost{background:transparent}
    .btn:active{transform:translateY(1px)}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{background:linear-gradient(180deg,rgba(255,255,255,.05),transparent);position:sticky;top:64px}
    tfoot td{font-weight:600;background:linear-gradient(180deg,transparent,rgba(255,255,255,.03))}
    .right{justify-content:flex-end}
    .badge{display:inline-block;background:#0d2533;border:1px solid #134357;color:#9eeeff;padding:4px 10px;border-radius:999px;font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:8px}
    .small{font-size:12px}
    .warning{color:#ffbe5e}
    .good{color:#20e3aa}
    .danger{color:#ff6b6b}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#111828; border:1px solid #25304a; border-bottom-width:2px;border-radius:6px;padding:0 6px;color:#c8e7ff}
    .sticky-tools{position:sticky;top:64px;padding:8px;background:#0b0e1acc;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);z-index:5;border-radius:12px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <h1>臨時スコア登録 <span class="badge">保存なし・3/4人対応</span></h1>
    <div class="sub">オカ/ウマ/チップを可変で試算できる簡易ページ（結果はコピー/印刷/エクスポートのみ）</div>
  </header>
  <main class="grid">

    <!-- 設定パネル -->
    <section class="card" id="settings-card">
      <h2>ルール設定</h2>
      <div class="content">
        <fieldset>
          <legend>基本</legend>
          <div class="row">
            <div>
              <label>人数</label>
              <select id="playerCount">
                <option value="4">4人打ち</option>
                <option value="3" selected>3人打ち</option>
              </select>
            </div>
            <div>
              <label>配給原点（開始持ち点）</label>
              <input type="number" id="startPoints" value="25000" step="100" />
              <div class="help">例: 25000</div>
            </div>
            <div>
              <label>原点（返しの基準点）</label>
              <input type="number" id="targetPoints" value="30000" step="100" />
              <div class="help">例: 30000</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>オカ（トップ賞）<span class="muted">（pt）</span></label>
              <input type="number" id="oka" value="20000" step="1000" />
              <div class="help">トップに配分される合計pt（例: 20000）。</div>
            </div>
            <div>
              <label>ウマ [1位,...,最下位] <span class="muted">（pt）</span></label>
              <input type="text" id="uma" value="20,0,-20" />
              <div class="help">人数に合わせてカンマ区切りで入力（例: <span class="kbd">20,0,-20</span> / <span class="kbd">30,10,-10,-30</span>）</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>端数処理</label>
              <select id="rounding">
                <option value="truncate" selected>100点単位で切り捨て</option>
                <option value="round">100点単位で四捨五入</option>
                <option value="ceil">100点単位で切り上げ</option>
                <option value="none">端数処理なし</option>
              </select>
              <div class="help">素点→返し点にする際の端数処理</div>
            </div>
            <div>
              <label>返し点の倍率 <span class="muted">（1pt=100点 → 100）</span></label>
              <input type="number" id="pointUnit" value="100" step="10" />
              <div class="help">通常は100</div>
            </div>
          </div>
        </fieldset>
        <div class="hr"></div>
        <fieldset>
          <legend>チップ</legend>
          <div class="row">
            <div>
              <label>チップ単価 <span class="muted">（pt/枚）</span></label>
              <input type="number" id="chipUnit" value="1" step="1" />
            </div>
            <div>
              <label>チップの合計チェック</label>
              <select id="chipSumPolicy">
                <option value="allow">合計が0でなくても許可</option>
                <option value="warn" selected>合計が0でなければ警告</option>
                <option value="enforce">合計が0でなければ計算しない</option>
              </select>
            </div>
          </div>
        </fieldset>
        <div class="actions right">
          <button class="btn" id="resetBtn">リセット</button>
          <button class="btn primary" id="calcBtn">計算する</button>
        </div>
      </div>
    </section>

    <!-- 入力＆結果 -->
    <section class="card" id="entry-card">
      <h2>プレイヤー入力</h2>
      <div class="content">
        <div class="row">
          <div><label>対局名（任意）</label><input type="text" id="title" placeholder="2025-08-15 夜卓 1半荘"/></div>
          <div><label>メモ（任意）</label><input type="text" id="memo" placeholder="東南・赤3 など"/></div>
        </div>
        <div class="row"><div class="muted">人数の変更は上部「基本＞人数」から。行は自動で増減します。</div></div>
        <div id="players"></div>
        <div class="actions">
          <button class="btn" id="swapByScoreBtn">スコア順に並び替え（降順）</button>
          <button class="btn" id="rankByScoreBtn">スコアから着順を自動入力</button>
          <button class="btn ghost" id="clearInputsBtn">入力をクリア</button>
        </div>
        <div class="sticky-tools row">
          <div class="pill small"><span class="muted">コピー:</span>
            <button class="btn" id="copyTsvBtn">TSV</button>
            <button class="btn" id="copyCsvBtn">CSV</button>
            <button class="btn" id="copyTextBtn">テキスト</button>
            <button class="btn" id="printBtn">印刷</button>
          </div>
          <div class="pill small"><span class="muted">エクスポート:</span>
            <button class="btn" id="exportJsonBtn">JSON</button>
          </div>
        </div>
        <div id="warn" class="muted" style="margin-top:8px"></div>
        <div id="resultWrap"></div>
      </div>
    </section>
  </main>

  <template id="player-row-tpl">
    <fieldset style="margin:10px 0">
      <legend class="nowrap">プレイヤー <span class="p-index"></span></legend>
      <div class="row">
        <div>
          <label>名前</label>
          <input type="text" class="p-name" placeholder="プレイヤー名" />
        </div>
        <div>
          <label>素点（終局時の点棒）</label>
          <input type="number" class="p-score" step="100" value="25000" />
        </div>
        <div>
          <label>着順</label>
          <select class="p-rank"></select>
        </div>
        <div>
          <label>チップ枚数</label>
          <input type="number" class="p-chips" step="1" value="0" />
        </div>
      </div>
    </fieldset>
  </template>

  <script>
    // ---------- ユーティリティ ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function parseUma(str, expected){
      const parts = String(str).split(/[,、\s]+/).map(s=>s.trim()).filter(Boolean).map(Number);
      if(parts.length !== expected || parts.some(n=>Number.isNaN(n))){
        throw new Error(`ウマは 人数(${expected})に合わせて ${expected} 個の数値を入力してください`);
      }
      return parts; // [uma1, uma2, ...] (pt)
    }

    function hundredAdjust(x, mode){
      if(mode==='none') return x;
      const unit = 100; // 100点単位
      if(mode==='truncate') return Math.floor(x / unit) * unit;
      if(mode==='round') return Math.round(x / unit) * unit;
      if(mode==='ceil') return Math.ceil(x / unit) * unit;
      return x;
    }

    function copyToClipboard(text){
      navigator.clipboard?.writeText(text).then(()=>{
        flashMsg('クリップボードにコピーしました','good');
      }).catch(()=>{ alert('コピーに失敗しました'); });
    }

    function toCSV(rows, sep=','){
      return rows.map(r=>r.map(v=>{
        const s = String(v ?? '');
        if(sep===',' && /[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      }).join(sep)).join('\n');
    }

    function flashMsg(msg, cls){
      const el = $('#warn'); el.textContent = msg; el.classList.remove('danger','good','warning'); if(cls) el.classList.add(cls);
      setTimeout(()=>{ if(el.textContent===msg) el.textContent=''; }, 2500);
    }

    // ---------- 入力初期化 ----------
    function buildRankOptions(select, n){
      select.innerHTML = '';
      for(let i=1;i<=n;i++){
        const o = document.createElement('option'); o.value=String(i); o.textContent=String(i); select.appendChild(o);
      }
    }

    function initPlayers(){
      const wrap = $('#players');
      wrap.innerHTML = '';
      const n = Number($('#playerCount').value || 4);
      for(let i=0;i<n;i++){
        const t = document.importNode($('#player-row-tpl').content, true);
        t.querySelector('.p-index').textContent = String(i+1);
        buildRankOptions(t.querySelector('.p-rank'), n);
        wrap.appendChild(t);
      }
      // デフォルトの着順は 1..n
      $$('.p-rank').forEach((sel, i)=> sel.value = String(i+1));
      // スコア初期値は開始持ち点
      const start = Number($('#startPoints').value || 25000);
      $$('.p-score').forEach((el)=> el.value = start);
    }

    // ---------- 計算ロジック ----------
    function calc(){
      const warn = $('#warn'); warn.textContent=''; warn.classList.remove('danger','good','warning');
      try{
        const title = $('#title').value.trim();
        const memo = $('#memo').value.trim();
        const n = Number($('#playerCount').value || 4);
        const startPoints = Number($('#startPoints').value || 25000);
        const targetPoints = Number($('#targetPoints').value || 30000);
        const oka = Number($('#oka').value || 20000); // pt（トップ取り切り方式）
        const umaArr = parseUma($('#uma').value, n);
        const rounding = $('#rounding').value; // none|truncate|round|ceil
        const pointUnit = Number($('#pointUnit').value || 100); // 1pt が何点か
        const chipUnit = Number($('#chipUnit').value || 1); // 1枚何pt
        const chipPolicy = $('#chipSumPolicy').value; // allow|warn|enforce

        // 入力の取り出し
        const players = $$('#players fieldset').map((fs, idx)=>{
          const name = $('.p-name', fs).value.trim() || `P${idx+1}`;
          const score = Number($('.p-score', fs).value || 0);
          const rank = Number($('.p-rank', fs).value || 0);
          const chips = Number($('.p-chips', fs).value || 0);
          return { idx, name, score, rank, chips };
        });

        // 妥当性
        const ranks = players.map(p=>p.rank);
        const uniq = new Set(ranks);
        if(uniq.size !== players.length){
          throw new Error('着順が重複しています（1〜人数分を1回ずつ指定してください）');
        }
        const maxRank = Math.max(...ranks);
        if(maxRank !== players.length || Math.min(...ranks)!==1){
          throw new Error('着順は 1 から 人数までの連番で指定してください');
        }

        // 返し点（素点→pt換算）
        const returns = players.map(p=>{
          const diff = p.score - targetPoints; // 点棒差
          const adj = hundredAdjust(p.score, rounding) - hundredAdjust(targetPoints, rounding);
          const use = (rounding==='none') ? diff : (adj);
          const pt = use / pointUnit; // pt
          return {name:p.name, rank:p.rank, basePt:pt, chips:p.chips, score:p.score};
        });

        // オカ配分（トップ取り切り）
        const withOka = returns.map(r=> ({...r, oka: r.rank===1 ? (oka/pointUnit) : 0}));

        // ウマ配分
        const withUma = withOka.map(r=> ({...r, uma: umaArr[r.rank-1]}));

        // チップ
        const chipSum = players.reduce((a,p)=>a + p.chips, 0);
        if(chipPolicy==='enforce' && chipSum!==0) throw new Error(`チップ合計が0ではありません（合計: ${chipSum}枚）`);
        if(chipPolicy==='warn' && chipSum!==0){ flashMsg(`注意: チップ合計が0ではありません（合計: ${chipSum}枚）`,'warning'); }
        const withChips = withUma.map(r=> ({...r, chipPt: r.chips * chipUnit}));

        // 合計pt
        const totals = withChips.map(r=> ({
          name: r.name,
          score: r.score,
          rank: r.rank,
          basePt: r.basePt,
          oka: r.oka,
          uma: r.uma,
          chip: r.chipPt,
          total: r.basePt + r.oka + r.uma + r.chip
        }));

        // サマリ検算
        const sumBase = totals.reduce((a,t)=>a+t.basePt,0);
        const sumOka = totals.reduce((a,t)=>a+t.oka,0);
        const sumUma = totals.reduce((a,t)=>a+t.uma,0);
        const sumChip= totals.reduce((a,t)=>a+t.chip,0);
        const sumTotal= totals.reduce((a,t)=>a+t.total,0);

        // 表レンダリング
        renderTable({title, memo, startPoints, targetPoints, oka, umaArr, pointUnit, chipUnit, n, totals, sumBase, sumOka, sumUma, sumChip, sumTotal});
      }catch(e){
        const warn = $('#warn'); warn.textContent = e.message; warn.classList.add('danger');
        $('#resultWrap').innerHTML = '';
      }
    }

    function renderTable(model){
      const {title,memo,startPoints,targetPoints,oka,umaArr,pointUnit,chipUnit,n,totals,sumBase,sumOka,sumUma,sumChip,sumTotal} = model;
      const header = `
        <div class="row" style="align-items:center;gap:14px">
          <div class="pill small"><span class="muted">対局名</span> <strong>${escapeHtml(title||'-')}</strong></div>
          <div class="pill small"><span class="muted">メモ</span> <strong>${escapeHtml(memo||'-')}</strong></div>
          <div class="pill small"><span class="muted">設定</span>
            <span class="badge">${n}人</span>
            <span class="badge">開始 ${startPoints.toLocaleString()}点</span>
            <span class="badge">原点 ${targetPoints.toLocaleString()}点</span>
            <span class="badge">オカ ${oka}pt</span>
            <span class="badge">ウマ ${umaArr.join('/') }pt</span>
            <span class="badge">1pt=${pointUnit}点</span>
            <span class="badge">チップ=${chipUnit}pt</span>
          </div>
        </div>`;

      const rows = totals.slice().sort((a,b)=>a.rank-b.rank).map(t=>`
        <tr>
          <td>${t.rank}位</td>
          <td>${escapeHtml(t.name)}</td>
          <td>${t.score.toLocaleString()}</td>
          <td>${fmt(t.basePt)}</td>
          <td>${fmt(t.oka)}</td>
          <td>${fmt(t.uma)}</td>
          <td>${fmt(t.chip)}</td>
          <td><strong>${fmt(t.total)}</strong></td>
        </tr>`).join('');

      const foot = `
        <tr>
          <td colspan="3">合計</td>
          <td>${fmt(sumBase)}</td>
          <td>${fmt(sumOka)}</td>
          <td>${fmt(sumUma)}</td>
          <td>${fmt(sumChip)}</td>
          <td>${fmt(sumTotal)}</td>
        </tr>`;

      const html = `
        ${header}
        <table>
          <thead>
            <tr><th>着順</th><th>名前</th><th>素点</th><th>返しpt</th><th>オカ</th><th>ウマ</th><th>チップ</th><th>合計pt</th></tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>${foot}</tfoot>
        </table>
      `;
      $('#resultWrap').innerHTML = html;
    }

    function fmt(n){
      const s = (Math.round(n*100)/100).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      return (n>0?'+':'') + s;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>\"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
    }

    // ---------- イベント ----------
    $('#calcBtn').addEventListener('click', calc);
    $('#resetBtn').addEventListener('click', ()=>{ initPlayers(); $('#warn').textContent=''; $('#resultWrap').innerHTML=''; })
    $('#playerCount').addEventListener('change', ()=>{ initPlayers(); });
    $('#startPoints').addEventListener('change', ()=>{ $$('.p-score').forEach((el)=> el.value = Number($('#startPoints').value||25000)); });

    $('#swapByScoreBtn').addEventListener('click', ()=>{
      const sets = $$('#players fieldset');
      sets.sort((a,b)=> Number($('.p-score',b).value||0) - Number($('.p-score',a).value||0)).forEach(el=>el.parentElement.appendChild(el));
    });
    $('#rankByScoreBtn').addEventListener('click', ()=>{
      const sets = $$('#players fieldset');
      const sorted = sets.slice().sort((a,b)=> Number($('.p-score',b).value||0) - Number($('.p-score',a).value||0));
      sorted.forEach((fs, i)=>{$('.p-rank', fs).value = String(i+1)});
    });
    $('#clearInputsBtn').addEventListener('click', ()=>{
      $$('.p-name').forEach((el)=> el.value = '');
      const start = Number($('#startPoints').value || 25000);
      $$('.p-score').forEach((el)=> el.value = start);
      const n = Number($('#playerCount').value||4);
      $$('.p-rank').forEach((el,i)=> el.value = String(i+1));
      $$('.p-chips').forEach((el)=> el.value = 0);
    });

    // コピー系
    function collectCurrentTableData(){
      const table = $('#resultWrap table'); if(!table) return null;
      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr=> Array.from(tr.children).map(td=> td.textContent.replace(/[+,]/g,'').trim()));
      const header = Array.from(table.querySelectorAll('thead th')).map(th=> th.textContent.trim());
      return {header, rows};
    }
    $('#copyTsvBtn').addEventListener('click', ()=>{
      const d = collectCurrentTableData(); if(!d) return;
      copyToClipboard(toCSV([d.header, ...d.rows], '\t'));
    });
    $('#copyCsvBtn').addEventListener('click', ()=>{
      const d = collectCurrentTableData(); if(!d) return;
      copyToClipboard(toCSV([d.header, ...d.rows], ','));
    });
    $('#copyTextBtn').addEventListener('click', ()=>{
      const d = collectCurrentTableData(); if(!d) return;
      const text = [d.header.join('\t'), ...d.rows.map(r=>r.join('\t'))].join('\n');
      copyToClipboard(text);
    });
    $('#printBtn').addEventListener('click', ()=>{ window.print(); });

    // JSONエクスポート（保存はしないがコピーして他ページに貼れる）
    $('#exportJsonBtn').addEventListener('click', ()=>{
      const payload = {
        meta: {
          title: $('#title').value.trim(),
          memo: $('#memo').value.trim(),
          createdAt: new Date().toISOString()
        },
        settings: {
          playerCount: Number($('#playerCount').value||4),
          startPoints: Number($('#startPoints').value || 25000),
          targetPoints: Number($('#targetPoints').value || 30000),
          oka: Number($('#oka').value || 20000),
          uma: $('#uma').value,
          rounding: $('#rounding').value,
          pointUnit: Number($('#pointUnit').value || 100),
          chipUnit: Number($('#chipUnit').value || 1)
        },
        players: $$('#players fieldset').map((fs, idx)=>({
          name: $('.p-name', fs).value.trim() || `P${idx+1}`,
          score: Number($('.p-score', fs).value || 0),
          rank: Number($('.p-rank', fs).value || 0),
          chips: Number($('.p-chips', fs).value || 0)
        }))
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'temp_result.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // 初期化
    initPlayers();
  </script>
</body>
</html>
