<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÊàêÁ∏æÁôªÈå≤</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.firebasestorage.app",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31",
      measurementId: "G-NP9EELBD7R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.addDoc = addDoc;
    window.collection = collection;
    window.onSnapshot = onSnapshot;
  </script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .main-button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 10px auto;
      padding: 15px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .main-button:hover { background-color: #0056b3; }
    .form-section {
      background: white;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label, select, input[type="number"], input[type="date"] {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .highlight { font-weight: bold; font-size: 20px; }
    #realtimeDisplay {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 10px;
      border-radius: 10px;
      margin-top: 30px;
      font-size: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<h1>ÊàêÁ∏æÁôªÈå≤</h1>
<button class="main-button" onclick="location.href='index.html'">„Éõ„Éº„É†„Å∏Êàª„Çã</button>

<div class="form-section">
  <label>Êó•‰ªòÔºö<input type="date" id="gameDate"></label>

  <label>„Éó„É¨„Ç§„É§„Éº1Ôºö</label>
  <select id="player1"></select>
  <input type="number" id="point1" placeholder="„Éù„Ç§„É≥„Éà">

  <label>„Éó„É¨„Ç§„É§„Éº2Ôºö</label>
  <select id="player2"></select>
  <input type="number" id="point2" placeholder="„Éù„Ç§„É≥„Éà">

  <label>„Éó„É¨„Ç§„É§„Éº3Ôºö</label>
  <select id="player3"></select>
  <input type="number" id="point3" placeholder="„Éù„Ç§„É≥„Éà">

  <label>„Éó„É¨„Ç§„É§„Éº4Ôºö</label>
  <select id="player4"></select>
  <input type="number" id="point4" placeholder="„Éù„Ç§„É≥„Éà">

  <button class="main-button" onclick="saveRecord()">‰øùÂ≠ò</button>
</div>

<div id="realtimeDisplay"></div>

<script type="module">
  import { collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('gameDate').value = `${yyyy}-${mm}-${dd}`;
    loadPlayers();
    setupRealtimeListener();
  });

  function loadPlayers() {
    const names = JSON.parse(localStorage.getItem('playerNames') || '[]');
    ['player1','player2','player3','player4'].forEach(id => {
      const select = document.getElementById(id);
      select.innerHTML = '';
      names.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    });
  }

  function saveRecord() {
    const date = document.getElementById('gameDate').value;
    const players = [
      { name: player1.value, point: Number(point1.value) },
      { name: player2.value, point: Number(point2.value) },
      { name: player3.value, point: Number(point3.value) },
      { name: player4.value, point: Number(point4.value) }
    ];

    const sum = players.reduce((acc, p) => acc + p.point, 0);
    if (Math.abs(sum) > 0.001) {
      alert("„Éù„Ç§„É≥„ÉàÂêàË®à„Åå¬±0„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ");
      return;
    }

    const session = {
      title: date,
      players: players.map(p => p.name),
      games: [ { date, players } ]
    };

    addDoc(collection(window.db, "sessions"), session)
      .then(() => alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ"))
      .catch(error => alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error));
  }

  function setupRealtimeListener() {
    const display = document.getElementById('realtimeDisplay');
    onSnapshot(collection(window.db, "sessions"), (snapshot) => {
      let html = '<h3>üì° „É™„Ç¢„É´„Çø„Ç§„É†„Åß‰øùÂ≠ò„Åï„Çå„Åü„Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß</h3>';
      snapshot.forEach(doc => {
        const data = doc.data();
        html += `<div><strong>${data.title}</strong>: ${data.games[0].players.map(p => `${p.name}(${p.point})`).join('„ÄÅ')}</div>`;
      });
      display.innerHTML = html;
    });
  }
</script>

</body>
</html>
