<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>メンバー登録</title>
<script type="module">
  // —— Firebase 初期化 ——
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    updateDoc,
    deleteDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
    authDomain: "mahjong-app-2e2e9.firebaseapp.com",
    projectId: "mahjong-app-2e2e9",
    storageBucket: "mahjong-app-2e2e9.appspot.com",
    messagingSenderId: "440425002404",
    appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31"
  };

  // Firebase 初期化
  const app   = initializeApp(firebaseConfig);
  const auth  = getAuth(app);
  const db    = getFirestore(app);
  const playersRef = collection(db, "players");

  // 匿名認証 → 認証後にページ初期化
  signInAnonymously(auth)
    .then(() => {
      console.log("🔑 匿名ログイン成功");
      setupMemberPage();
    })
    .catch(err => console.error("⚠️ 認証失敗:", err.message));

  // 認証状態の監視（デバッグ用）
  onAuthStateChanged(auth, user => {
    if (user) console.log("👤 ログインユーザー:", user.uid);
    else     console.log("🚪 ログアウト中");
  });

  // メンバーページ初期化関数
  function setupMemberPage() {
    const nameInput = document.getElementById("playerName");
    const addButton = document.getElementById("addButton");
    const list      = document.getElementById("memberList");

    // 名前追加処理
    addButton.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      if (!name) return alert("名前を入力してください");
      const id = "player_" + Date.now();
      await setDoc(doc(db, "players", id), { id, name });
      nameInput.value = "";
    });

    // メンバー一覧をリアルタイム取得・描画
    onSnapshot(playersRef, snapshot => {
      list.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const li   = document.createElement("li");

        // 表示用スパン
        const span = document.createElement("span");
        span.textContent = data.name;

        // 編集用テキスト入力
        const input = document.createElement("input");
        input.type = "text";
        input.value = data.name;
        input.style.display = "none";

        // 編集ボタン
        const editBtn = document.createElement("button");
        editBtn.textContent = "編集";
        editBtn.addEventListener("click", () => {
          span.style.display  = "none";
          input.style.display = "inline-block";
          saveBtn.style.display = "inline-block";
        });

        // 保存ボタン
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "保存";
        saveBtn.style.display = "none";
        saveBtn.addEventListener("click", async () => {
          const newName = input.value.trim();
          if (!newName) return alert("名前を入力してください");
          await updateDoc(doc(db, "players", data.id), { name: newName });
          span.textContent = newName;
          span.style.display  = "inline";
          input.style.display = "none";
          saveBtn.style.display = "none";
        });

        // 削除ボタン
        const delBtn = document.createElement("button");
        delBtn.textContent = "削除";
        delBtn.addEventListener("click", async () => {
          if (confirm("本当に削除しますか？")) {
            await deleteDoc(doc(db, "players", data.id));
          }
        });

        li.append(span, input, editBtn, saveBtn, delBtn);
        list.appendChild(li);
      });
    });
  }
</script>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    h1 { text-align: center; }
    .form { text-align: center; margin: 20px 0; }
    input[type="text"] { padding: 10px; font-size: 16px; margin-bottom: 5px; }
    button { padding: 6px 10px; font-size: 14px; margin-left: 5px; cursor: pointer; }
    ul { list-style: none; padding: 0; max-width: 400px; margin: 0 auto; }
    li { background: white; padding: 10px; margin-bottom: 5px; border-radius: 5px; }
    .top-nav { text-align: center; margin-bottom: 20px; }
    .main-button { padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .main-button:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h1>メンバー登録</h1>
  <div class="top-nav">
    <button class="main-button" onclick="location.href='index.html'">ホームへ戻る</button>
  </div>
  <div class="form">
    <input id="playerName" placeholder="名前を入力" type="text"/>
    <button id="addButton">追加</button>
  </div>
  <ul id="memberList"></ul>
</body>
</html>
