<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¯¾æˆ¦å±¥æ­´</title>
  <style>
    body { font-family: sans-serif; background-color: #f0f0f0; padding: 20px; }
    h1 { text-align: center; margin-bottom: 10px; }
    .filter-box { text-align: center; margin-bottom: 20px; }
    .filter-box input { padding: 8px; margin: 5px; font-size: 14px; }
    .top-nav { text-align: center; margin-bottom: 20px; }
    .main-button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .main-button:hover { background-color: #0056b3; }
    .session { background: #ffffff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 20px; }
    .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .edit-button, .action-panel button {
      margin-left: 8px; padding: 5px 10px; border: none; border-radius: 6px;
      background: #007bff; color: white; cursor: pointer;
    }
    .edit-button:hover, .action-panel button:hover { background: #0056b3; }
    .action-panel { display: none; margin-top: 10px; }
    .game { background: #f8f8f8; border-radius: 5px; padding: 8px; margin: 5px 0; display: flex; justify-content: space-between; }
    .game .text { flex-grow: 1; }
    .game .delete-game-btn { margin-left: 10px; background: #dc3545; color: white; border: none; padding: 3px 6px; border-radius: 4px; font-size: 0.8em; cursor: pointer; }
    .summary-box { background: #eef; padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 14px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); }
    .modal-content { background-color: white; margin: 10% auto; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .modal-content h3 { margin-top: 0; }
    .modal-content .player-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .modal-content select, .modal-content input { flex: 1; padding: 8px; }
  </style>
</head>
<body>
<h1>å¯¾æˆ¦å±¥æ­´</h1>
<div class="top-nav">
  <button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
</div>
<div class="filter-box">
  <label>é–‹å§‹æ—¥: <input id="startDate" type="date" /></label>
  <label>çµ‚äº†æ—¥: <input id="endDate" type="date" /></label>
</div>
<div id="historyContainer"></div>
<!-- ä»¥é™ã‚¹ã‚¯ãƒªãƒ—ãƒˆç­‰ã¯å¤‰æ›´ãªã— -->

<div id="addModal" class="modal">
  <div class="modal-content">
    <h3>åŠè˜ã‚’è¿½åŠ </h3>
    <div id="addForm"></div>
    <button onclick="saveNewHanchan()">ä¿å­˜</button>
    <button onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h3>å‰Šé™¤ç¢ºèª</h3>
    <p>ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <button onclick="confirmDeleteGame()">å‰Šé™¤</button>
    <button onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>
<script type="module">
  // â€”â€” Firebase åˆæœŸåŒ– â€”â€”  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    signInAnonymously,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    doc,
    updateDoc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
    authDomain: "mahjong-app-2e2e9.firebaseapp.com",
    projectId: "mahjong-app-2e2e9",
    storageBucket: "mahjong-app-2e2e9.appspot.com",
    messagingSenderId: "440425002404",
    appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const playersRef  = collection(db, "players");
  const sessionsRef = collection(db, "sessions");

  // åŒ¿åèªè¨¼ â†’ èªè¨¼å®Œäº†å¾Œã«ã®ã¿ Firestore æ“ä½œã‚’èµ·å‹•
  signInAnonymously(auth)
    .then(() => console.log("ğŸ”‘ åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ"))
    .catch(error => console.error("âš ï¸ èªè¨¼å¤±æ•—:", error.message));

  onAuthStateChanged(auth, user => {
    if (user) console.log("ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user.uid);
    else     console.log("ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­");
  });

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿
  let playerMap = {};
  let playerList = [];
  async function loadPlayerMap() {
    playerMap = {};
    playerList = [];
    const snap = await getDocs(playersRef);
    snap.forEach(docSnap => {
      const data = docSnap.data();
      playerMap[data.id] = data.name;
      playerList.push(data);
    });
  }

  // åŠè˜è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  let currentSessionId = null;
  function openAddModal(sessionId) {
    currentSessionId = sessionId;
    const form = document.getElementById("addForm");
    form.innerHTML = "";
    for (let i = 0; i < 4; i++) {
      const row = document.createElement("div");
      row.className = "player-row";

      const select = document.createElement("select");
      playerList.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });

      const input = document.createElement("input");
      input.type = "number";
      input.placeholder = "ãƒã‚¤ãƒ³ãƒˆ";

      row.appendChild(select);
      row.appendChild(input);
      form.appendChild(row);
    }
    document.getElementById("addModal").style.display = "block";
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeModal() {
    document.getElementById("addModal").style.display = "none";
  }

  // å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚µãƒãƒªã‚’ç”Ÿæˆ
  function summarizePoints(games) {
    const totals = {};
    games.forEach(game => {
      game.players.forEach(p => {
        totals[p.id] = (totals[p.id] || 0) + p.point;
      });
    });
    return Object.entries(totals)
      .map(([id, pt]) => `${playerMap[id] || id}: ${pt >= 0 ? "+" : ""}${pt.toFixed(1)}pt`)
      .join("<br>");
  }

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’æç”»
  function renderSessions(sessions) {
    const container = document.getElementById("historyContainer");
    container.innerHTML = "";
    sessions.forEach(session => {
      const div = document.createElement("div");
      div.className = "session";

      const summary = summarizePoints(session.games);
      const gamesHTML = session.games.map((game, i) => {
        const detail = game.players
          .map(p => `${playerMap[p.id] || p.id}(${p.point})`)
          .join(" / ");
        return `
          <div class="game">
            <div class="text">${game.date}ï¼š${detail}</div>
            <button class="delete-game-btn" onclick="deleteGame('${session.id}', ${i})">ğŸ—‘</button>
          </div>`;
      }).join("");

      div.innerHTML = `
        <div class="session-header">
          <h3>${session.title}</h3>
          <button class="edit-button" onclick="openAddModal('${session.id}')">åŠè˜è¿½åŠ </button>
        </div>
        ${gamesHTML}
        <div class="summary-box">${summary}</div>
      `;
      container.appendChild(div);
    });
  }

  // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
  function filterSessions(sessions) {
    const start = document.getElementById("startDate").value;
    const end   = document.getElementById("endDate").value;
    return sessions.filter(s =>
      (!start || s.title >= start) &&
      (!end   || s.title <= end)
    );
  }

  // æ–°ã—ã„åŠè˜ã‚’ä¿å­˜
  async function saveNewHanchan() {
    const rows = document.querySelectorAll("#addForm .player-row");
    const players = Array.from(rows).map(row => {
      const id    = row.querySelector("select").value;
      const point = parseFloat(row.querySelector("input").value);
      return { id, point };
    });
    if (players.some(p => isNaN(p.point))) {
      alert("ã™ã¹ã¦ã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }
    const sum = players.reduce((a, b) => a + b.point, 0);
    if (Math.abs(sum) > 0.01) {
      alert("åˆè¨ˆç‚¹ãŒÂ±0ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
      return;
    }

    const sessionRef = doc(db, "sessions", currentSessionId);
    const snap       = await getDoc(sessionRef);
    const data       = snap.data();
    const newGame    = { date: new Date().toISOString().split("T")[0], players };
    const newGames   = data.games.concat(newGame);

    await updateDoc(sessionRef, { games: newGames });
    closeModal();
    loadAndDisplay();
  }

  // åŠè˜ã‚’å‰Šé™¤
  async function deleteGame(sessionId, gameIndex) {
    if (!confirm("ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const sessionRef = doc(db, "sessions", sessionId);
    const snap       = await getDoc(sessionRef);
    const data       = snap.data();
    data.games.splice(gameIndex, 1);
    await updateDoc(sessionRef, { games: data.games });
    loadAndDisplay();
  }

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾— â†’ æç”»
  async function loadAndDisplay() {
    await loadPlayerMap();
    const snap     = await getDocs(sessionsRef);
    const sessions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderSessions(filterSessions(sessions));
  }

  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã¨åˆå›è¡¨ç¤º
  document.getElementById("startDate").addEventListener("change", loadAndDisplay);
  document.getElementById("endDate").addEventListener("change", loadAndDisplay);
  loadAndDisplay();

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
  window.openAddModal   = openAddModal;
  window.deleteGame     = deleteGame;
  window.saveNewHanchan = saveNewHanchan;
  window.closeModal     = closeModal;
</script>
</body>
</html>
