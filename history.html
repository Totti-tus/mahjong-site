<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¯¾æˆ¦å±¥æ­´</title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    body { 
      font-family: sans-serif; 
      background-color: #f0f0f0; 
      padding: 20px; 
      margin: 0; 
    }
    h1 { 
      text-align: center; 
      margin-bottom: 10px; 
    }
    .top-nav {
      text-align: center;
      margin-bottom: 20px;
    }
    .main-button {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .main-button:hover { 
      background-color: #0056b3; 
    }
    .filter-box {
      text-align: center; 
      margin-bottom: 20px; 
    }
    .filter-box input {
      padding: 8px; 
      margin: 5px; 
      font-size: 14px; 
    }
    .session {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .edit-button, .delete-game-btn {
      margin-left: 8px;
      padding: 5px 10px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    .edit-button:hover, .delete-game-btn:hover {
      background: #0056b3;
    }
    .delete-game-btn {
      background: #dc3545;
    }
    .delete-game-btn:hover {
      background: #a71d2a;
    }
    .game {
      background: #f8f8f8;
      border-radius: 5px;
      padding: 8px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .game .text {
      flex-grow: 1;
      font-size: 14px;
    }
    .summary-box {
      background: #eef;
      padding: 8px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .modal-content h3 {
      margin-top: 0;
      font-size: 18px;
    }
    .modal-content .player-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .modal-content select, .modal-content input {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>å¯¾æˆ¦å±¥æ­´</h1>
  <div class="top-nav">
    <button class="main-button" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  </div>
  <div class="filter-box">
    <label>é–‹å§‹æ—¥: <input id="startDate" type="date" /></label>
    <label>çµ‚äº†æ—¥: <input id="endDate" type="date" /></label>
  </div>
  <div id="historyContainer"></div>

  <!-- è¿½åŠ ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="addModal" class="modal">
    <div class="modal-content">
      <h3>åŠè˜ã‚’è¿½åŠ </h3>
      <div id="addForm"></div>
      <button class="main-button" onclick="saveNewHanchan()">ä¿å­˜</button>
      <button class="main-button" style="background:#6c757d; margin-top:10px;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä»Šå›ã¯ã‚²ãƒ¼ãƒ å˜ä½ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãŸã‚ä¸è¦ã€ä»Šå¾Œã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½å‰Šé™¤ã‚’å®Ÿè£…ã™ã‚‹ãªã‚‰ã“ã“ã«è¿½åŠ ï¼‰ -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>å‰Šé™¤ç¢ºèª</h3>
      <p>ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
      <button class="main-button delete-game-btn" onclick="confirmDeleteGame()">å‰Šé™¤</button>
      <button class="main-button" style="background:#6c757d; margin-top:10px;" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <script type="module">
    // ã¾ãšFirebase Appã‚’åˆæœŸåŒ–ã—ã€ãã‚Œã‹ã‚‰Authã‚„Firestoreã‚’ä½¿ã†
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Firebase è¨­å®šï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦å¤‰æ›´ä¸è¦ï¼‰ ---
    const firebaseConfig = {
      apiKey: "AIzaSyBUw-RFVRCQGkEnxy8Uo57Hcer39G0kIUI",
      authDomain: "mahjong-app-2e2e9.firebaseapp.com",
      projectId: "mahjong-app-2e2e9",
      storageBucket: "mahjong-app-2e2e9.appspot.com",
      messagingSenderId: "440425002404",
      appId: "1:440425002404:web:fc5d188d05d4fb26b6fd31"
    };

    // Firebase App ã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);

    // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œ
    const auth = getAuth();
    signInAnonymously(auth)
      .then(() => {
        console.log("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
      })
      .catch((error) => {
        console.error("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—:", error.message);
      });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:", user.uid);
      } else {
        console.log("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“");
      }
    });

    // Firestore ã®å‚ç…§
    const db = getFirestore(app);
    const playersRef = collection(db, "players");
    const sessionsRef = collection(db, "sessions");

    let playerMap = {};      // { playerId: playerName, ... }
    let playerList = [];     // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±é…åˆ— [{ id, name }, ... ]
    let currentSessionId = null; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ç·¨é›†ã™ã‚‹å¯¾è±¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ ID

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒã‚¹ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ playerMap / playerList ã‚’æ§‹ç¯‰
     */
    async function loadPlayerMap() {
      playerMap = {};
      playerList = [];
      const snap = await getDocs(playersRef);
      snap.forEach(docSnap => {
        const data = docSnap.data();
        playerMap[data.id] = data.name;
        playerList.push(data);
      });
    }

    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆåŠè˜è¿½åŠ ï¼‰
     * @param {string} sessionId - å¯¾è±¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
     */
    function openAddModal(sessionId) {
      currentSessionId = sessionId;
      const form = document.getElementById("addForm");
      form.innerHTML = "";

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¸æŠï¼‹ãƒã‚¤ãƒ³ãƒˆå…¥åŠ›ã‚’ 4 è¡Œåˆ†ç”Ÿæˆ
      for (let i = 0; i < 4; i++) {
        const row = document.createElement("div");
        row.className = "player-row";

        // ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ï¼‰
        const select = document.createElement("select");
        playerList.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.name;
          select.appendChild(opt);
        });

        // å…¥åŠ›ï¼ˆãƒã‚¤ãƒ³ãƒˆï¼‰
        const input = document.createElement("input");
        input.type = "number";
        input.placeholder = "ãƒã‚¤ãƒ³ãƒˆ";
        input.min = "-200"; // å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
        input.max = "200";  // å¿…è¦ã«å¿œã˜ã¦èª¿æ•´

        row.appendChild(select);
        row.appendChild(input);
        form.appendChild(row);
      }

      document.getElementById("addModal").style.display = "block";
    }

    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆåŠè˜è¿½åŠ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰
     */
    function closeModal() {
      document.getElementById("addModal").style.display = "none";
    }

    /**
     * æ–°è¦åŠè˜ï¼ˆã‚²ãƒ¼ãƒ ï¼‰ã‚’ä¿å­˜ã™ã‚‹
     * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã® games é…åˆ—ã«è¿½åŠ ã—ã€Firestore ã‚’æ›´æ–°
     */
    async function saveNewHanchan() {
      const rows = document.querySelectorAll("#addForm .player-row");
      const players = Array.from(rows).map(row => {
        const id = row.querySelector("select").value;
        const point = parseFloat(row.querySelector("input").value);
        return { id, point };
      });

      // æœªå…¥åŠ›ãƒã‚§ãƒƒã‚¯
      if (players.some(p => isNaN(p.point))) {
        alert("ã™ã¹ã¦ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç‚¹æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      // åˆè¨ˆãƒã‚§ãƒƒã‚¯
      const sum = players.reduce((acc, p) => acc + p.point, 0);
      if (Math.abs(sum) > 0.01) {
        alert("åˆè¨ˆç‚¹ãŒÂ±0ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      // Firestore ä¸Šã®è©²å½“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦æ›´æ–°
      const sessionRef = doc(db, "sessions", currentSessionId);
      const snap = await getDoc(sessionRef);
      const data = snap.data() || { title: "", games: [], players: [] };

      // ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ï¼ˆplayers ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰ã‚‚æ›´æ–°
      const newPlayersList = Array.from(new Set([
        ...data.players,
        ...players.map(p => p.id)
      ]));

      // games é…åˆ—ã«è¿½åŠ 
      const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
      const newGame = { date: today, players };
      const newGames = data.games.concat(newGame);

      await updateDoc(sessionRef, {
        games: newGames,
        players: newPlayersList
      });

      closeModal();
      loadAndDisplay();  // å†æç”»
    }

    /**
     * æŒ‡å®šã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®æŒ‡å®šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚²ãƒ¼ãƒ ã‚’å‰Šé™¤ã™ã‚‹
     * ï¼ˆä»Šå›ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ç„¡ã—ã€‚ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ç¢ºèª â†’ æ›´æ–° â†’ å†æç”»ï¼‰
     * @param {string} sessionId 
     * @param {number} gameIndex 
     */
    async function deleteGame(sessionId, gameIndex) {
      if (!confirm("ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      const sessionRef = doc(db, "sessions", sessionId);
      const snap = await getDoc(sessionRef);
      const data = snap.data() || { games: [] };
      const gamesArray = data.games || [];
      if (gameIndex < 0 || gameIndex >= gamesArray.length) return;
      gamesArray.splice(gameIndex, 1);
      await updateDoc(sessionRef, { games: gamesArray });
      loadAndDisplay();
    }

    /**
     * ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’å–å¾— â†’ æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰ â†’ ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆé–‹å§‹ãƒ»çµ‚äº†æ—¥ï¼‰ â†’ æç”»
     */
    async function loadAndDisplay() {
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒƒãƒ—ã‚’æœ€æ–°åŒ–
      await loadPlayerMap();

      // Firestore ã‹ã‚‰ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
      const snap = await getDocs(sessionsRef);
      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ID ã‚‚å«ã‚ã¦ãƒ‡ãƒ¼ã‚¿åŒ–
      const sessions = snap.docs.map(docSnap => {
        const d = docSnap.data();
        return { id: docSnap.id, ...d };
      });

      // **ã‚»ãƒƒã‚·ãƒ§ãƒ³å˜ä½ã§ã€Œã‚¿ã‚¤ãƒˆãƒ«ï¼ˆï¼æ—¥ä»˜ï¼‰ã€ã‚’ã‚­ãƒ¼ã«ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰**
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒ YYYY-MM-DD ã«ãªã£ã¦ã„ã‚‹å‰æ
      sessions.sort((a, b) => {
        // b.title > a.title ã®ã¨ããƒ—ãƒ©ã‚¹ â†’ b ãŒå…ˆï¼ˆæ–°ã—ã„ï¼‰
        if (b.title > a.title) return 1;
        if (b.title < a.title) return -1;
        return 0;
      });

      // é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã§ãƒ•ã‚£ãƒ«ã‚¿
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const filtered = sessions.filter(s => {
        if (start && s.title < start) return false;
        if (end && s.title > end) return false;
        return true;
      });

      renderSessions(filtered);
    }

    /**
     * ä¸ãˆã‚‰ã‚ŒãŸã‚»ãƒƒã‚·ãƒ§ãƒ³é…åˆ—ã‚’ HTML ã«æç”»
     * @param {Array} sessions 
     */
    function renderSessions(sessions) {
      const container = document.getElementById("historyContainer");
      container.innerHTML = "";

      sessions.forEach(session => {
        const div = document.createElement("div");
        div.className = "session";

        // åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—ï¼†HTMLåŒ–
        const summary = summarizePoints(session.games);
        // å€‹åˆ¥ã‚²ãƒ¼ãƒ è¡Œã‚’æ•´å½¢
        const gamesHTML = session.games.map((game, i) => {
          const detail = game.players
            .map(p => `${playerMap[p.id] || p.id}(${p.point})`)
            .join("ï¼");
          return `
            <div class="game">
              <div class="text">${game.date}ï¼š${detail}</div>
              <button class="delete-game-btn" onclick="deleteGame('${session.id}', ${i})">ğŸ—‘</button>
            </div>`;
        }).join("");

        div.innerHTML = `
          <div class="session-header">
            <h3>${session.title}</h3>
            <button class="edit-button" onclick="openAddModal('${session.id}')">åŠè˜è¿½åŠ </button>
          </div>
          ${gamesHTML}
          <div class="summary-box">${summary}</div>
        `;
        container.appendChild(div);
      });
    }

    /**
     * ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ã™ã¹ã¦ã®ã‚²ãƒ¼ãƒ ã‚’é›†è¨ˆã—ã€
     * å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆè¨ˆãƒã‚¤ãƒ³ãƒˆã‚’æ–‡å­—åˆ—ã«æ•´å½¢ã—ã¦è¿”ã™
     * @param {Array} games 
     * @returns {string} HTML æ–‡å­—åˆ—
     */
    function summarizePoints(games) {
      const totals = {};
      games.forEach(game => {
        game.players.forEach(p => {
          if (!totals[p.id]) totals[p.id] = 0;
          totals[p.id] += p.point;
        });
      });
      return Object.entries(totals)
        .map(([id, pt]) => `${playerMap[id] || id}: ${pt >= 0 ? '+' : ''}${pt.toFixed(1)}pt`)
        .join('<br>');
    }

    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ã«å†æç”»
    document.getElementById("startDate").addEventListener("change", loadAndDisplay);
    document.getElementById("endDate").addEventListener("change", loadAndDisplay);

    // æœ€åˆã«èª­ã¿è¾¼ã¿ãƒ»æç”»
    loadAndDisplay();

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆonclick ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ï¼‰
    window.openAddModal = openAddModal;
    window.closeModal = closeModal;
    window.saveNewHanchan = saveNewHanchan;
    window.deleteGame = deleteGame;
    window.closeDeleteModal = () => document.getElementById("deleteModal").style.display = "none";

  </script>
</body>
</html>
